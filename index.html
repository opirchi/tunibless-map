<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø®Ø±ÙŠØ·Ø© ØªÙˆÙ†Ø³ â€” Ù†Ø³Ø®Ø© Ù…Ø­ØµÙ‘Ù†Ø©</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />

  <style>
    :root{
      --accent: #00796b;
      --accent-dark: #005a4f;
      --muted: #55606a;
      --hover-color: #ffc107;
      --feature-fill: #e6f9f4;
      --feature-border: #0b6b5e;
      --label-bg: rgba(255,255,255,0.95);
      --label-color: #073642;
    }

    html,body{ height:100%; margin:0; font-family: "Noto Kufi Arabic", "Segoe UI", Tahoma, Arial; background:#f5fbf9; color:#073642; }
    .wrap{ max-width:1200px; margin:18px auto; padding:16px; display:grid; grid-template-columns: 1fr 340px; gap:18px; align-items:start }
    header{ grid-column:1/-1; }
    h1{ margin:0 0 6px 0; font-size:20px }
    p.lead{ margin:0; color:var(--muted); }

    .map-card{ background:#fff; border-radius:12px; padding:10px; box-shadow:0 10px 30px rgba(3,56,48,0.06); height:720px; overflow:hidden }
    #map{ width:100%; height:100%; border-radius:8px; background-color: #eef6f2; }

    .side{ background:#fff; border-radius:12px; padding:14px; box-shadow:0 10px 26px rgba(3,56,48,0.04); height:720px; overflow:auto }
    .meta { color:var(--muted); margin-top:6px; }

    .btn{ display:inline-block; padding:10px 12px; border-radius:10px; font-weight:700; border:0; cursor:pointer; width:100%; text-align:center; }
    .btn-primary{ background:var(--accent); color:#fff; transition: background-color 0.18s ease; }
    .btn-primary:hover{ background:var(--accent-dark); }

    /* label style */
    .g-label {
      display:inline-block;
      white-space: nowrap;
      padding:6px 10px;
      border-radius:8px;
      background: var(--label-bg);
      color: var(--label-color);
      font-weight:700;
      font-size:13px;
      box-shadow: 0 3px 12px rgba(3,56,48,0.12);
      transform-origin:center;
    }
    .g-label.label-hover {
      transform: scale(1.18);
      box-shadow: 0 8px 24px rgba(3,56,48,0.18);
    }

    @media (max-width:980px){
      .wrap{ grid-template-columns:1fr; padding:10px }
      .side{ height:auto; order:2 }
      .map-card{ height:520px; order:1 }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„ØªÙˆÙ†Ø³ â€” Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</h1>
      <p class="lead">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø§ÙˆØ³ ÙÙ‚Ø· â€” Ø§Ù†Ù‚Ø± Ù„ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„.</p>
    </header>

    <div class="map-card">
      <div id="map"></div>
    </div>

    <aside class="side" aria-live="polite">
      <h2 id="g-name">Ø§Ø®ØªØ± ÙˆÙ„Ø§ÙŠØ©</h2>
      <p class="meta" id="side-sub">Ù…Ø±Ù‘Ø± Ø§Ù„Ù…Ø§ÙˆØ³ ÙÙˆÙ‚ Ø£ÙŠ ÙˆÙ„Ø§ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ø³Ù…Ù‡Ø§ ÙˆØªÙƒØ¨ÙŠØ±Ù‡Ø§.</p>
      <div style="margin-top:12px">
        <button class="btn btn-primary" id="openFormBtn" disabled>ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      </div>
      <hr />
      <p style="color:var(--muted); font-size:13px">
        Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ ÙƒØ§Ø¦Ù† <code>FORM_LINKS</code> Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ø§Ù„Ù…ÙØ§ØªÙŠØ­: Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø®Ø§ØµÙŠØ© <code>gouv_fr</code> Ø¯Ø§Ø®Ù„ GeoJSON).
      </p>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <!-- Turf.js (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† ÙŠÙØ­Ø³Ù‘Ù† ÙˆØ¶Ø¹ Ø§Ù„Ù…Ù„ØµÙ‚Ø§Øª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¶Ù„Ø¹ Ø¨Ø¯Ù‚Ù‘Ø©) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    const GEOJSON_URL = 'TN-gouvernorats.geojson';

    const FORM_LINKS = {
      /* Ø¶Ø¹ Ù‡Ù†Ø§: "Ariana": "https://....", ... */
    };

    const map = L.map('map', { zoomControl: true, attributionControl: false }).setView([34.0, 9.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { minZoom: 6, maxZoom: 14, attribution: 'Â© OpenStreetMap' }).addTo(map);

    const gNameEl = document.getElementById('g-name');
    const openFormBtn = document.getElementById('openFormBtn');

    let geojsonLayer = null;
    let boundsAll = null;

    function styleFeature(feature) {
      return {
        color: getComputedStyle(document.documentElement).getPropertyValue('--feature-border').trim() || '#0b6b5e',
        weight: 1.2,
        fillColor: getComputedStyle(document.documentElement).getPropertyValue('--feature-fill').trim() || '#e6f9f4',
        fillOpacity: 0.9
      };
    }
    const highlightStyle = {
      weight: 2.8,
      color: '#014d43',
      fillColor: getComputedStyle(document.documentElement).getPropertyValue('--hover-color').trim() || '#ffc107',
      fillOpacity: 0.95
    };

    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ø­Ø§Ù„Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    let currentLabelMarker = null;
    let currentHoveredName = null;
    let currentFeatureProps = null;

    // Ø¯Ø§Ù„Ø© Ù‡Ø±ÙˆØ¨ Ø£Ø­Ø±Ù HTML
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return String(unsafe).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    // Ø­Ø³Ø§Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„ØªØ³Ù…ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¶Ù„Ø¹ (Ù†Ø³ØªØ®Ø¯Ù… Turf Ø¥Ù† ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… bounds center)
    function getFeatureLabelLatLng(feature, layer) {
      try {
        if (window.turf) {
          // Ù†ÙØ¶Ù‘Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… pointOnFeature Ø£Ùˆ centerOfMass Ø¥Ù† ÙƒØ§Ù†Øª Ù…ØªØ§Ø­Ø©
          if (turf.pointOnFeature) {
            const p = turf.pointOnFeature(feature);
            return [p.geometry.coordinates[1], p.geometry.coordinates[0]];
          }
          if (turf.centerOfMass) {
            const p = turf.centerOfMass(feature);
            return [p.geometry.coordinates[1], p.geometry.coordinates[0]];
          }
          if (turf.centroid) {
            const p = turf.centroid(feature);
            return [p.geometry.coordinates[1], p.geometry.coordinates[0]];
          }
        }
      } catch (err) {
        // ØªØ¬Ø§Ù‡Ù„ Ø£Ø®Ø·Ø§Ø¡ turf ÙˆØ§Ø³ØªØ®Ø¯Ø§Ù… fallback
        console.warn('turf error:', err);
      }
      // fallback: Ù…Ø±ÙƒØ² Ø§Ù„Ù€ bounds (ÙŠØ¹Ù…Ù„ ÙÙŠ Ù…Ø¹Ø¸Ù… Ø§Ù„Ø­Ø§Ù„Ø§Øª)
      if (layer && layer.getBounds) {
        return layer.getBounds().getCenter();
      }
      return null;
    }

    function showLabelAt(layer, text, feature) {
      removeCurrentLabel();
      const pos = getFeatureLabelLatLng(feature || layer.feature, layer);
      if (!pos) return;
      // Ø¥Ù†Ø´Ø§Ø¡ DivIcon Ù„Ù„ØªØ³Ù…ÙŠØ© (Ù†Ø­ÙˆÙ‘Ù„ Ø§Ù„Ù†Øµ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©)
      const html = `<div class="g-label label-hover">${escapeHtml(text)}</div>`;
      const div = L.divIcon({ className: '', html, iconSize: [120, 36], iconAnchor: [60, 18] });
      currentLabelMarker = L.marker(pos, { icon: div, interactive: false }).addTo(map);
    }

    function removeCurrentLabel() {
      if (currentLabelMarker) {
        try { map.removeLayer(currentLabelMarker); } catch (e) {}
        currentLabelMarker = null;
      }
    }

    function onEachFeature(feature, layer) {
      // Ù†Ø­Ø§ÙˆÙ„ Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ø³Ù… ÙØ±Ù†Ø³ÙŠ Ù…ÙˆØ«ÙˆÙ‚
      const french = (feature.properties && (feature.properties.gouv_fr || feature.properties.nom_fr || feature.properties.name_fr)) || 'Unknown';
      const arabic = (feature.properties && (feature.properties.gouv_ar || feature.properties.nom_ar)) || '';

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙØ§Ø¹Ù„
      layer.on({
        mouseover: function(e) {
          // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø´ÙƒÙ„
          e.target.setStyle(highlightStyle);
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) e.target.bringToFront();

          // Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø¹Ù†Ø¯ Ù†Ù‚Ø·Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¶Ù„Ø¹
          showLabelAt(e.target, french, feature);

          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ùˆ Ø²Ø± Ø§Ù„ÙØªØ­
          gNameEl.textContent = french + (arabic ? ` â€” ${arabic}` : '');
          openFormBtn.disabled = false;
          currentHoveredName = french;
          currentFeatureProps = feature.properties;
        },
        mouseout: function(e) {
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          geojsonLayer.resetStyle(e.target);
          removeCurrentLabel();
          gNameEl.textContent = 'Ø§Ø®ØªØ± ÙˆÙ„Ø§ÙŠØ©';
          openFormBtn.disabled = true;
          currentHoveredName = null;
          currentFeatureProps = null;
        },
        click: function(e) {
          // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±: Ù†ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù† ÙˆÙØ¬Ø¯ØŒ ÙˆØ¥Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„ØªØ³Ù…ÙŠØ© (Ù…ÙÙŠØ¯ Ù„Ù„Ù…Ø³Ù‘)
          const frenchName = french;
          const link = (frenchName && FORM_LINKS[frenchName]) ? FORM_LINKS[frenchName] : null;
          if (link) {
            window.open(link, '_blank');
          } else {
            // Ù„Ù„Ù…Ø³Ù‘: Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ø§Ø¨Ø·ØŒ Ù†Ø¹Ø±Ø¶/Ù†Ø®ÙÙŠ Ø§Ù„ØªØ³Ù…ÙŠØ© (toggle)
            // Ø¥Ø°Ø§ Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¢Ù†ØŒ Ù†Ø¹Ø±Ø¶Ù‡Ø§
            if (!currentLabelMarker) {
              showLabelAt(e.target, french, feature);
              gNameEl.textContent = french + (arabic ? ` â€” ${arabic}` : '');
              openFormBtn.disabled = false;
              currentHoveredName = french;
            } else {
              removeCurrentLabel();
              gNameEl.textContent = 'Ø§Ø®ØªØ± ÙˆÙ„Ø§ÙŠØ©';
              openFormBtn.disabled = true;
              currentHoveredName = null;
            }
          }
        },
        // Ø¯Ø¹Ù… Ù„Ù…Ø³ ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù„Ù„Ù…Ø³
        touchstart: function(e) {
          // ØªØ¹Ø§Ù…Ù„ ÙƒÙ€ mouseover
          this.fire('mouseover', e);
        }
      });
    }

    // ØªØ­Ù…ÙŠÙ„ GeoJSON
    fetch(GEOJSON_URL)
      .then(res => {
        if (!res.ok) throw new Error('HTTP ' + res.status);
        return res.json();
      })
      .then(data => {
        if (!data || !data.features || !data.features.length) throw new Error('Ù…Ù„Ù GeoJSON Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ features.');

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ© (Ø¨Ø¯ÙˆÙ† ØªØ³Ù…ÙŠØ§Øª Ø¯Ø§Ø¦Ù…Ø©)
        geojsonLayer = L.geoJSON(data, {
          style: styleFeature,
          onEachFeature: onEachFeature
        }).addTo(map);

        boundsAll = geojsonLayer.getBounds();
        if (boundsAll && boundsAll.isValid()) {
          map.fitBounds(boundsAll, { padding: [20,20] });
          map.setMaxBounds(boundsAll.pad(0.6));
        }
      })
      .catch(err => {
        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ GeoJSON:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª. ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù TN-gouvernorats.geojson Ù…ÙˆØ¬ÙˆØ¯ ÙˆØµØ§Ù„Ø­.');
      });

    // Ø²Ø± ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    openFormBtn.addEventListener('click', () => {
      const fr = currentHoveredName;
      const link = (fr && FORM_LINKS[fr]) ? FORM_LINKS[fr] : null;
      if (link) window.open(link, '_blank');
      else alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù…Ø³Ø¬Ù„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙÙŠ FORM_LINKS.');
    });

    // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„ØªÙƒØ¨ÙŠØ±/Ø§Ù„ØªØµØºÙŠØ±
    map.on('zoomend moveend', () => {
      if (!geojsonLayer || !currentLabelMarker || !currentHoveredName) return;
      // Ø¥Ù† ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ ØªØ³Ù…ÙŠØ© Ø­Ø§Ù„ÙŠØ© ÙØ£Ø¹Ø¯ ÙˆØ¶Ø¹Ù‡Ø§ Ø§Ø³ØªÙ†Ø§Ø¯Ø§Ù‹ Ø¥Ù„Ù‰ Ø¢Ø®Ø± feature Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ø§Ø³Ù…
      // Ù†Ø¨Ø­Ø« Ø£ÙˆÙ„ feature ÙŠÙ…Ù„Ùƒ Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙØ±Ù†Ø³ÙŠ
      let found = null;
      geojsonLayer.eachLayer(layer => {
        const french = (layer.feature && layer.feature.properties && (layer.feature.properties.gouv_fr || layer.feature.properties.nom_fr)) || '';
        if (!found && french === currentHoveredName) found = { layer, feature: layer.feature };
      });
      if (found) {
        // Ø¥Ø¹Ø§Ø¯Ø© ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ù…ÙŠØ© Ø¨Ø¯Ù‚Ø©
        removeCurrentLabel();
        showLabelAt(found.layer, currentHoveredName, found.feature);
      }
    });
  </script>
</body>
</html>
