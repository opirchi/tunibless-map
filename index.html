<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Ø®Ø±ÙŠØ·Ø© Ø£Ù‚Ø§Ù„ÙŠÙ… ØªÙˆÙ†Ø³</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body, html { height: 100%; margin: 0; padding: 0; font-family: "Cairo", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; display: flex; flex-direction: column; overflow: hidden; background-color: #f0f0f0; }
    #header { padding: 10px 15px; background: #fff; border-bottom: 1px solid #ddd; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; flex-shrink: 0; }
    #toggle-legend-btn { display: none; padding: 5px 10px; font-size: 1.2rem; background: #f8f8f8; border: 1px solid #ccc; border-radius: 5px; cursor: pointer; }
    #header label { font-weight: bold; flex-shrink: 0; }
    #region-filter { padding: 8px; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; flex-grow: 1; min-width: 200px; }
    .main-container { position: relative; flex-grow: 1; display: flex; overflow: hidden; }
    #legend-container { width: 340px; background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.1); z-index: 1001; overflow-y: auto; flex-shrink: 0; transition: margin-right 0.3s ease; padding-bottom:20px;}
    #map-wrapper { flex-grow: 1; position: relative; }
    #map { height: 100%; width: 100%; }
    #loader { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; z-index: 1002; transform: translate(-50%, -50%); }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .legend-panel h4 { margin: 0; padding: 15px; text-align: center; background: #f9f9f9; border-bottom: 1px solid #eee; font-size: 18px; }
    .legend-region { padding: 0 15px 15px; }
    .legend-region h5 { margin: 15px 0 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; display: flex; align-items: center; font-size: 16px; }
    .legend-region h5 .region-icon { width: 20px; height: 20px; display: inline-block; margin-left: 8px; border-radius: 50%; border: 2px solid #555; }
    .legend-panel ul { list-style: none; padding: 0; margin: 0; }
    .legend-panel li { display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background-color 0.2s; }
    .legend-panel li:hover { background-color: #f5f5f5; }
    .legend-panel li:last-child { border-bottom: none; }
    .legend-panel .gov-name { font-weight: 500; }
    .legend-panel .coordinator-name { color: #555; font-size: 13px; }
    .legend-panel .member-count { font-weight: bold; color: #007bff; margin-right: 8px; font-size: 13px; }
    .reset-view-button { position: absolute; top: 10px; left: 10px; z-index: 1000; background: white; color: #333; width: 30px; height: 30px; line-height: 30px; text-align: center; border-radius: 4px; box-shadow: 0 1px 5px rgba(0,0,0,0.65); cursor: pointer; font-size: 1.2rem; text-decoration: none; }
    .reset-view-button:hover { background: #f4f4f4; }
    .leaflet-popup-content-wrapper { border-radius: 8px; }
    .popup-link { display: block; text-align: center; margin-top: 10px; padding: 8px 15px; background-color: #007bff; color: white !important; text-decoration: none; border-radius: 5px; font-weight: bold; }
    .leaflet-tooltip { background: rgba(0,0,0,0.7); color: white; border: none; padding: 8px; border-radius: 4px; box-shadow: none; }
    .custom-tooltip { background: rgba(0,123,255,0.9) !important; color:#fff !important; font-size:14px; font-weight:bold; padding:6px 10px; border-radius:6px; }
    @media (max-width: 768px) {
      #toggle-legend-btn { display: block; }
      #legend-container { position: absolute; height: 100%; margin-right: -340px; }
      #legend-container.visible { margin-right: 0; }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

  <div id="header">
    <button id="toggle-legend-btn" title="Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¯Ù„ÙŠÙ„">â˜°</button>
    <div style="flex-basis:100%; display:flex; align-items:center; gap:10px;">
      <img src="https://i.imgur.com/rvVqkm6.png" alt="Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©" style="width:50px; height:50px; border-radius:50%; border:2px solid #007bff;">
      <span style="font-weight:bold; font-size:16px;">Ø§Ù„Ù…Ù†Ø³Ù‚Ø© Ø§Ù„ÙˆØ·Ù†ÙŠØ©: Ø³Ø¹Ø§Ø¯ Ø§Ù„Ø¨Ø´ </span>
    </div>
    <label for="region-filter">ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…:</label>
    <select id="region-filter">
      <option value="all">ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ…</option>
    </select>
  </div>

  <div class="main-container">
    <div id="legend-container"></div>
    <div id="map-wrapper">
      <div id="map"></div>
      <div id="loader"></div>
      <a id="reset-view-btn" class="reset-view-button" title="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¹Ø±Ø¶">&#x21BA;</a>

      <div style="position:absolute; bottom:20px; right:20px; z-index:1000;">
        <button id="generate-pdf-btn"
          style="
            background: linear-gradient(90deg, #007bff, #00b4d8);
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
          "
          onmouseover="this.style.transform='scale(1.05)'"
          onmouseout="this.style.transform='scale(1)'">
           ğŸ“„ ØªØ­Ù…ÙŠÙ„ PDF Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        </button>
      </div>

    </div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    const regionData = {
      "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ": { coordinator_name: "ØµÙˆÙÙŠØ© Ø§Ù„Ø¬Ù„Ø§Ù„ÙŠ" },
      "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ": { coordinator_name: "Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨" },
      "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ": { coordinator_name: "Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨" },
      "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ": { coordinator_name: "Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨" },
      "Ø§Ù„Ø¬Ù†ÙˆØ¨":       { coordinator_name: "Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨" }
    };
    const governorateData = {
      "Tunis":     { members: 1748, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ ØªÙˆÙ†Ø³" },
      "Ariana":      { members: 1074, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø£Ø±ÙŠØ§Ù†Ø©" },
      "Ben Arous": { members: 1559, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù‡Ø§Ø¬Ø± Ø§Ù„Ø³ÙŠØ¯" },
      "Manouba":   { members: 887, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ø­Ø§Ù…Ø¯ Ø§Ù„Ø¯Ø±ÙŠØ¯ÙŠ" },
      "Nabel":     { members: 1494, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ù†Ø§Ø¨Ù„" },
      "Zagouen":   { members: 300, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø²ØºÙˆØ§Ù†" },
      "Bizerte":   { members: 1004, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø¨Ù†Ø²Ø±Øª" },
      "Beja":        { members: 369, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø¨Ø§Ø¬Ø©" },
      "Jandouba":    { members: 646, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø¬Ù†Ø¯ÙˆØ¨Ø©" },
      "Le kef":      { members: 831, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø§Ù„ÙƒØ§Ù" },
      "Siliana":   { members: 234, region: "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø³Ù„ÙŠØ§Ù†Ø©" },
      "Sousse":      { members: 1376, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø³ÙˆØ³Ø©" },
      "Monastir":    { members: 1091, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø§Ù„Ù…Ù†Ø³ØªÙŠØ±" },
      "Mahdia":      { members: 746, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø§Ù„Ù…Ù‡Ø¯ÙŠØ©" },
      "Sfax":        { members: 1461, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ ØµÙØ§Ù‚Ø³" },
      "Kairouan":    { members: 618, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø§Ù„Ù‚ÙŠØ±ÙˆØ§Ù†" },
      "kasserine": { members: 485, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø§Ù„Ù‚ØµØ±ÙŠÙ†" },
      "Sidi Bouzid":{ members: 968, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ø³ÙŠØ¯ÙŠ Ø¨ÙˆØ²ÙŠØ¯" },
      "Gafsa":     { members: 1447, region: "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", coordinator_name: "Ù…Ù†Ø³Ù‚ Ù‚ÙØµØ©" },
      "Touzer":      { members: 972, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù…Ù†Ø³Ù‚ ØªÙˆØ²Ø±" },
      "Kebili":      { members: 802, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù…Ù†Ø³Ù‚ Ù‚Ø¨Ù„ÙŠ" },
      "Gabes":     { members: 3806, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù…Ù†Ø³Ù‚ Ù‚Ø§Ø¨Ø³" },
      "Mednine":   { members: 2754, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù…Ù†Ø³Ù‚ Ù…Ø¯Ù†ÙŠÙ†" },
      "Tataouine": { members: 883, region: "Ø§Ù„Ø¬Ù†ÙˆØ¨", coordinator_name: "Ù…Ù†Ø³Ù‚ ØªØ·Ø§ÙˆÙŠÙ†" }
    };
    const formsLinks = {
      "Ariana": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-ariana",
      "Beja": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-beja",
      "Ben Arous": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-ben-arous",
      "Bizerte": "https://sites.google.com/view/bizerte1/accueil",
      "Gabes": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-gabes",
      "Gafsa": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-gafsa",
      "Jandouba": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-jandouba",
      "Kairouan": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-kairouan",
      "Kasserine": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-kasserine",
      "Kebili": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-kebili",
      "Le kef": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-le-kef",
      "Mahdia": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-mahdia",
      "Manouba": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-manouba",
      "Mednine": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-medenine",
      "Monastir": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-monastir",
      "Nabel": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-nabeul",
      "Sfax": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-sfax",
      "Sidiâ€¯Bouzid": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-sidi-bouzid",
      "Siliana": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-siliana",
      "Sousse": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-sousse",
      "Tataouine": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-tataouine",
      "Touzer": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-tozeur",
      "Tunis": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-tunis",
      "Zagouen": "https://hexaflexagon-mushroom-czyl.squarespace.com/anmeldung-zaghouan"
    };
    const regionColors = { "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ": "#0096c7", "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ": "#52b69a", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ": "#f77f00", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ": "#ffe6a7", "Ø§Ù„Ø¬Ù†ÙˆØ¨": "#e63946" };

    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    const loader = document.getElementById('loader');
    const regionFilter = document.getElementById('region-filter');
    const legendContainer = document.getElementById('legend-container');
    const toggleButton = document.getElementById('toggle-legend-btn');
    const map = L.map('map', { center: [34, 9.5], zoom: 7, zoomControl: false, attributionControl: false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {}).addTo(map);
    let geojsonLayer;
    let lastSelectedLayer = null;
    const regionBounds = {}, gouvFrToAr = {}, layersByGouvFr = {};

    function style(feature) {
      const gouvFr = feature.properties.gouv_fr;
      const data = governorateData[gouvFr];
      const region = data ? data.region : null;
      return { fillColor: regionColors[region] || '#cccccc', weight: 1.5, opacity: 1, color: 'white', fillOpacity: 0.85 };
    }

    function buildLegend() {
      let html = '<div class="legend-panel"><h4>Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… ÙˆØ§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ†</h4>';
      for (const regionName in regionData) {
        const regionInfo = regionData[regionName];
        html += `<div class="legend-region">
                  <h5><span class="region-icon" style="background:${regionColors[regionName]}"></span>${regionName}</h5>
                  <p><strong>Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ:</strong> ${regionInfo.coordinator_name}</p><ul>`;
        for (const gouvFr in governorateData) {
          if (governorateData[gouvFr].region === regionName) {
            const gouvData = governorateData[gouvFr];
            const gouvAr = gouvFr; // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù‡Ù†Ø§ Ø¥Ù† Ø£Ø±Ø¯Øª
            const memberDisplay = gouvData.members > 0 ? `<span class="member-count">(${gouvData.members.toLocaleString('ar')})</span>` : '';
            html += `<li data-gouv-fr="${gouvFr}"><span class="gov-name">${gouvAr}</span><div>${memberDisplay}<span class="coordinator-name">${gouvData.coordinator_name}</span></div></li>`;
          }
        }
        html += `</ul></div>`;
      }
      html += `</div>`;
      legendContainer.innerHTML = html;
    }

    fetch('TNâ€‘gouvernorats.geojson')
      .then(res => res.json())
      .then(geojson => {
        geojson.features.forEach(feature => {
            const gouvFr = feature.properties.gouv_fr;
            gouvFrToAr[gouvFr] = feature.properties.gouv_ar || gouvFr;
            layersByGouvFr[gouvFr] = null;
            const data = governorateData[gouvFr];
            if (data && data.region) {
                const layerBounds = L.geoJSON(feature).getBounds();
                if (!regionBounds[data.region]) { regionBounds[data.region] = layerBounds; } 
                else { regionBounds[data.region].extend(layerBounds); }
            }
        });

        geojsonLayer = L.geoJSON(geojson, {
          style: style,
          onEachFeature: function(feature, layer) {
            const props = feature.properties;
            const gouvNameFr = props.gouv_fr;
            const gouvAr = gouvFrToAr[gouvNameFr];
            layersByGouvFr[gouvNameFr] = layer;
            const gouvData = governorateData[gouvNameFr];
            const formUrl = formsLinks[gouvNameFr];

            let popupText = `<h3 style="margin:0;">${gouvAr}</h3>`;
            if (gouvData) {
                if (gouvData.members > 0) popupText += `<p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${gouvData.members.toLocaleString('ar')}</p>`;
                if (gouvData.coordinator_name) popupText += `<p>Ø§Ù„Ù…Ù†Ø³Ù‚ Ø§Ù„Ø¥Ù‚Ù„ÙŠÙ…ÙŠ: ${gouvData.coordinator_name}</p>`;
            }
            if (formUrl) popupText += `<a href="${formUrl}" target="_blank" class="popup-link">ÙØªØ­ Ø§Ø³ØªÙ…Ø§Ø±Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</a>`;
            layer.bindPopup(popupText, { minWidth: 180 });

            let tooltipContent = `<b>${gouvAr}</b>`;
            if (gouvData) {
              if (gouvData.members > 0) tooltipContent += `<br>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${gouvData.members.toLocaleString('ar')}`;
              if (gouvData.coordinator_name) tooltipContent += `<br>Ø§Ù„Ù…Ù†Ø³Ù‚: ${gouvData.coordinator_name}`;
            }
            layer.bindTooltip(tooltipContent, { sticky: true, direction: 'top', className: 'custom-tooltip' });

            if (isTouchDevice) {
              layer.on('click', e => {
                  if (lastSelectedLayer) geojsonLayer.resetStyle(lastSelectedLayer);
                  e.target.setStyle({ weight: 3, color: '#333', fillOpacity: 1 });
                  lastSelectedLayer = e.target;
                  layer.openPopup();
              });
            } else {
              layer.on({
                mouseover: e => { if (regionFilter.value==='all') e.target.setStyle({ weight: 3, color: '#333', fillOpacity: 1 }); },
                mouseout: e => { if (regionFilter.value==='all') geojsonLayer.resetStyle(e.target); },
                click: e => { if (formUrl) window.open(formUrl, '_blank'); }
              });
            }

          }
        }).addTo(map);

        const fullBounds = geojsonLayer.getBounds();
        map.fitBounds(fullBounds);
        map.setMaxBounds(fullBounds.pad(0.1));
        buildLegend();

        toggleButton.addEventListener('click', e => { e.stopPropagation(); legendContainer.classList.toggle('visible'); });
        map.on('click', () => legendContainer.classList.remove('visible'));

        regionFilter.addEventListener('change', function() {
            const selectedRegion = this.value;
            if (selectedRegion === 'all') {
                map.fitBounds(fullBounds);
                geojsonLayer.eachLayer(layer => geojsonLayer.resetStyle(layer));
            } else {
                map.fitBounds(regionBounds[selectedRegion]);
                geojsonLayer.eachLayer(layer => {
                    const gouvData = governorateData[layer.feature.properties.gouv_fr];
                    if (gouvData && gouvData.region === selectedRegion) geojsonLayer.resetStyle(layer);
                    else layer.setStyle({ fillOpacity: 0.1, weight: 0.5, color: '#ccc' });
                });
            }
        });

        document.getElementById('reset-view-btn').addEventListener('click', () => {
            regionFilter.value = 'all';
            regionFilter.dispatchEvent(new Event('change'));
        });

        legendContainer.querySelectorAll('li[data-gouv-fr]').forEach(item => {
            const gouvFr = item.dataset.gouvFr;
            const layer = layersByGouvFr[gouvFr];
            if(layer) {
                item.addEventListener('mouseover', () => { if(regionFilter.value==='all') layer.fire('mouseover'); });
                item.addEventListener('mouseout', () => { if(regionFilter.value==='all') layer.fire('mouseout'); });
                item.addEventListener('click', () => { if (isTouchDevice) layer.openPopup(); else layer.fire('click'); });
            }
        });

        loader.style.display = 'none';

      })
      .catch(err => {
        console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ GeoJSON:', err);
        loader.style.display = 'none';
      });

    // ØªÙˆÙ„ÙŠØ¯ PDF
    document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
      const { jsPDF } = window.jspdf;
      const mapCanvas = await html2canvas(document.getElementById('map'), {useCORS:true});
      const imgData = mapCanvas.toDataURL('image/png');
      const pdf = new jsPDF({orientation: 'landscape', unit:'px', format:[mapCanvas.width, mapCanvas.height+300]});
      pdf.addImage(imgData, 'PNG', 0,0,mapCanvas.width,mapCanvas.height);

      pdf.setFont('helvetica');
      pdf.setFontSize(16);
      pdf.setTextColor(0,0,0);

      let yOffset = mapCanvas.height + 30;
      pdf.text("ğŸ“Œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø§Ù„ÙŠÙ… ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ†:", 10, yOffset);
      yOffset += 30;

      const regionsOrdered = ["Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„Ø´Ø±Ù‚ÙŠ", "Ø§Ù„Ø´Ù…Ø§Ù„ Ø§Ù„ØºØ±Ø¨ÙŠ", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„Ø´Ø±Ù‚ÙŠ", "Ø§Ù„ÙˆØ³Ø· Ø§Ù„ØºØ±Ø¨ÙŠ", "Ø§Ù„Ø¬Ù†ÙˆØ¨"];
      regionsOrdered.forEach(region => {
        pdf.setTextColor(regionColors[region] || 0);
        pdf.setFontSize(14);
        pdf.text(`ğŸ”¹ ${region}`, 10, yOffset);
        yOffset += 22;
        for (const gouv in governorateData) {
          const data = governorateData[gouv];
          if(data.region === region){
            const line = `â€¢ ${gouv}: ${data.members.toLocaleString('ar')} Ø¹Ø¶Ùˆ - Ø§Ù„Ù…Ù†Ø³Ù‚: ${data.coordinator_name}`;
            pdf.setTextColor(0);
            pdf.setFontSize(12);
            pdf.text(line, 20, yOffset);
            yOffset += 18;
          }
        }
        yOffset += 12;
      });

      pdf.save("Tunibless_Tunisia_Map_Dynamic.pdf");
    });

  </script>

</body>
</html>
