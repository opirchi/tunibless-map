<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø®Ø±ÙŠØ·Ø© ØªÙˆÙ†Ø³ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© (Ø¬ØºØ±Ø§ÙÙŠØ© Ø¯Ù‚ÙŠÙ‚Ø©) â€” TuniBless</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <style>
    :root{ --accent:#00796b; --muted:#55606a; }
    body{ font-family: "Noto Kufi Arabic", "Segoe UI", Tahoma, Arial; margin:0; background:#f5fbf9; color:#073642 }
    .wrap{ max-width:1200px; margin:20px auto; padding:18px; display:grid; grid-template-columns: 1fr 360px; gap:18px }
    header{ grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:8px }
    header h1{ margin:0; font-size:20px }
    header p{ margin:0; color:var(--muted) }
    .map-card{ background:#fff; border-radius:12px; padding:10px; box-shadow:0 10px 30px rgba(3,56,48,0.06); height:720px; overflow:hidden }
    #map{ width:100%; height:100%; border-radius:8px }
    .side{ background:linear-gradient(180deg,#ffffff,#fbfffe); border-radius:12px; padding:14px; box-shadow:0 10px 26px rgba(3,56,48,0.04); height:720px; overflow:auto }
    .side h2{ margin:0 0 6px 0 }
    .meta{ color:var(--muted); font-size:14px }
    .info-row{ display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f7faf8; border-radius:8px; margin-top:12px }
    .btn{ display:inline-block; padding:10px 12px; border-radius:10px; font-weight:700; border:0; cursor:pointer }
    .btn-primary{ background:var(--accent); color:#fff }
    .btn-ghost{ background:transparent; color:var(--accent); border:1px solid #e6f3ef }
    .small{ font-size:13px; color:var(--muted) }
    .legend{ margin-top:14px; font-size:13px; color:var(--muted) }
    @media (max-width:980px){ .wrap{ grid-template-columns:1fr } .side{ height:auto } .map-card{ height:520px } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ğŸ“ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„ØªÙˆÙ†Ø³ â€” Ù…Ø­Ø§ÙØ¸Ø§Øª Ø¯Ù‚ÙŠÙ‚Ø©</h1>
        <p class="meta">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø£ÙŠ Ù…Ø­Ø§ÙØ¸Ø© Ù„ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø§Øµ Ø¨Ù‡Ø§. Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯ ØªÙØ³ØªØ¯Ø¹Ù‰ Ù…Ù† Google Sheets (Ù…Ø¨Ø§Ø´Ø±).</p>
      </div>
      <div style="text-align:left">
        <small class="small">TuniBless â€” Ø¥ØµØ¯Ø§Ø± HTML Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ÙØ¹ (Ø§ÙØ¯Ù…Ø¬Ù‡ ÙÙŠ Google Sites Ø¹Ø¨Ø± "Embed URL" Ø£Ùˆ iframe)</small>
      </div>
    </header>
    <div class="map-card" role="region" aria-label="Ø®Ø±ÙŠØ·Ø© ØªÙˆÙ†Ø³ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©">
      <div id="map"></div>
    </div>
    <aside class="side" aria-live="polite">
      <h2 id="side-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©</h2>
      <div class="meta" id="side-sub">Ù…Ø±Ù‘Ø± ÙÙˆÙ‚ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø£Ùˆ Ø§Ø¶ØºØ· Ø¹Ù„ÙŠÙ‡Ø§ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª. Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­ÙŠØ© ØªØ³ØªÙ†Ø¯ Ø¥Ù„Ù‰ Ø¬Ø¯ÙˆÙ„ Google Sheets.</div>
      <div class="info-row" style="margin-top:12px">
        <div>
          <div style="font-weight:800" id="g-name">Ø§Ø®ØªØ± Ù…Ø­Ø§ÙØ¸Ø©</div>
          <div class="small">Ø§Ù„Ù…Ù†Ø³Ù‚: <span id="g-coord">ØºÙŠØ± Ù…Ø­Ø¯Ø¯</span></div>
        </div>
        <div style="text-align:left">
          <div class="small">Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†</div>
          <div style="font-weight:800; color:#073642" id="g-count">0</div>
        </div>
      </div>
      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn btn-primary" id="openFormBtn">ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
        <button class="btn btn-ghost" id="copyLinkBtn">Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
      </div>
      <div class="legend">
        <strong>Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©:</strong>
        <div class="small" style="margin-top:6px">ğŸ”’ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù…ÙŠÙ† ØªÙØ®Ø²Ù† ÙÙ‚Ø· Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ù†Ø³Ù‚ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠÙŠÙ†.</div>
      </div>
      <hr style="margin:14px 0; border:none; height:1px; background:#eef6f2;" />
      <div class="small">Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ: Ø£Ù†Ø´Ø¦ Google Sheet ÙˆØ§Ù†Ø´Ø±Ù‡ (Publish to web)ØŒ Ø«Ù… Ø¶Ø¹ Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ±Ù‚Ø© (Sheet ID) ÙÙŠ Ø§Ù„Ù…ÙØªØºÙŠÙ‘Ø± <code>SHEET_ID</code> ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø£Ø¯Ù†Ø§Ù‡.</div>
      <details style="margin-top:12px"><summary style="cursor:pointer">ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø³Ø±ÙŠØ¹Ø© Ù„Ø±Ø¨Ø· Google Sheets</summary>
        <ol class="small">
          <li>Ø£Ù†Ø´Ø¦ Google Sheet ÙŠØ­ØªÙˆÙŠ Ø¹Ù…ÙˆØ¯ÙŠÙ†: <code>governorate</code> (Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©) Ùˆ<code>count</code> (Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†).</li>
          <li>Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© File â†’ Share â†’ Publish to web â†’ Ø§Ø®ØªØ± sheet â†’ Publish.</li>
          <li>Ø§Ù†Ø³Ø® Ù…Ø¹Ø±Ù Ø§Ù„ÙˆØ±Ù‚Ø© Ù…Ù† Ø±Ø§Ø¨Ø· URL: Ø¨ÙŠÙ† <code>/d/</code> Ùˆ<code>/edit</code>.</li>
          <li>Ø§Ù„ØµÙ‚ Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± <code>SHEET_ID</code> Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯.</li>
        </ol>
      </details>
    </aside>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const GEOJSON_URL = 'TN-gouvernorats.geojson';
    const FORM_LINKS = {
      "Tunis":"https://forms.gle/tunis-form", "Ariana":"https://forms.gle/ariana-form", "Ben Arous":"https://forms.gle/benarous-form", "Manouba":"https://forms.gle/manouba-form", "Nabeul":"https://forms.gle/nabeul-form", "Zaghouan":"https://forms.gle/zaghouan-form", "Bizerte":"https://forms.gle/bizerte-form", "BÃ©ja":"https://forms.gle/beja-form", "Jendouba":"https://forms.gle/jendouba-form", "Le Kef":"https://forms.gle/kef-form", "Siliana":"https://forms.gle/siliana-form", "Sousse":"https://forms.gle/sousse-form", "Monastir":"https://forms.gle/monastir-form", "Mahdia":"https://forms.gle/mahdia-form", "Kairouan":"https://forms.gle/kairouan-form", "Sfax":"https://forms.gle/sfax-form", "Gabes":"https://forms.gle/gabes-form", "Medenine":"https://forms.gle/medenine-form", "Tataouine":"https://forms.gle/tataouine-form", "Tozeur":"https://forms.gle/tozeur-form", "Kebili":"https://forms.gle/kebili-form", "Gafsa":"https://forms.gle/gafsa-form", "Sidi Bouzid":"https://forms.gle/sidibouzid-form", "Kasserine":"https://forms.gle/kasserine-form"
    };
    const SHEET_ID = 'PUT_YOUR_SHEET_ID_HERE';
    const SHEET_NAME = 'Sheet1';
    const map = L.map('map', { zoomControl:true, minZoom:6, maxZoom:12 }).setView([34.0, 9.0], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);
    function styleFeature(feature){ return { color: '#0b6b5e', weight: 1.2, fillColor: '#e6f9f4', fillOpacity: 0.9 }; }
    let counts = {};
    async function loadCountsFromSheet(){
      if(!SHEET_ID || SHEET_ID.includes('PUT_YOUR')) return;
      try{
        const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
        const res = await fetch(url);
        const txt = await res.text();
        const json = JSON.parse(txt.substring(txt.indexOf('\n')+1).replace(/^[\s\S]*?\(/,'').replace(/\);?$/,''));
        const rows = json.table.rows;
        rows.forEach(r=>{
          const governorate = (r.c[0] && r.c[0].v) ? r.c[0].v.toString().trim() : null;
          const cnt = (r.c[1] && r.c[1].v) ? Number(r.c[1].v) : 0;
          if(governorate) counts[governorate] = cnt;
        });
        console.log('Loaded counts from sheet', counts);
      }catch(e){ console.warn('Failed to load sheet counts (check SHEET_ID and Publish to web):', e); }
    }
    const nameMap = { "Tunis":"Tunis","Ariana":"Ariana","Ben Arous":"Ben Arous","Manouba":"Manouba", "Nabeul":"Nabeul","Zaghouan":"Zaghouan","Bizerte":"Bizerte","Beja":"BÃ©ja", "Jendouba":"Jendouba","Kef":"Le Kef","Siliana":"Siliana","Sousse":"Sousse", "Monastir":"Monastir","Mahdia":"Mahdia","Kairouan":"Kairouan","Sfax":"Sfax", "Gabes":"Gabes","Medenine":"Medenine","Tataouine":"Tataouine","Tozeur":"Tozeur", "Kebili":"Kebili","Gafsa":"Gafsa","Sidi Bouzid":"Sidi Bouzid","Kasserine":"Kasserine" };
    const sideTitle = document.getElementById('side-title');
    const gNameEl = document.getElementById('g-name');
    const gCoordEl = document.getElementById('g-coord');
    const gCountEl = document.getElementById('g-count');
    const openFormBtn = document.getElementById('openFormBtn');
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    let currentFeature = null;
    function selectGovernorate(propName, feature){
      const displayName = propName;
      const mapKey = nameMap[propName] || propName;
      currentFeature = feature;
      gNameEl.textContent = displayName;
      gCoordEl.textContent = 'Ù„Ù… ÙŠÙØ­Ø¯Ø¯ Ø¨Ø¹Ø¯';
      gCountEl.textContent = counts[mapKey] !== undefined ? counts[mapKey] : 0;
      openFormBtn.onclick = ()=>{ const link = FORM_LINKS[mapKey] || '#'; window.open(link,'_blank') };
      copyLinkBtn.onclick = async ()=>{
        const link = FORM_LINKS[mapKey] || '';
        if(!link) return alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©.');
        try{ await navigator.clipboard.writeText(link); copyLinkBtn.textContent='ØªÙ… Ø§Ù„Ù†Ø³Ø®!'; setTimeout(()=>copyLinkBtn.textContent='Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù…ÙˆØ°Ø¬',1200);}catch(e){ alert('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·: '+link) }
    }
    }
    function highlightFeature(e){
      const layer = e.target;
      layer.setStyle({ weight:2.8, color:'#01695f', fillColor:'#dff6f0' });
      if(!L.Browser.ie && !L.Browser.opera && !L.Browser.edge){ layer.bringToFront(); }
      const name = layer.feature.properties.governorate || layer.feature.properties.name || layer.feature.properties.NAME_1 || layer.feature.properties.Governorat || layer.feature.properties.gouv;
      selectGovernorate(name, layer.feature);
    }
    function resetHighlight(e){ geojson.resetStyle(e.target); }
    function onEachFeature(feature, layer){
      const name = feature.properties.governorate || feature.properties.name || feature.properties.NAME_1 || feature.properties.Governorat || feature.properties.gouv || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      layer.bindTooltip(`<strong>${name}</strong>`, {direction:'top', offset:[0,-8], permanent:false, className:'tt'});
      layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: ()=>{ selectGovernorate(name, feature); const link = FORM_LINKS[nameMap[name]||name] || '#'; window.open(link,'_blank'); } });
    }
    let geojson = null;
    async function loadGeoJSON(){
      try{
        const resp = await fetch(GEOJSON_URL);
        if(!resp.ok) throw new Error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ GeoJSON');
        const data = await resp.json();
        console.log('sample feature properties:', data.features && data.features[0] && data.features[0].properties);
        geojson = L.geoJSON(data, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);
        map.fitBounds(geojson.getBounds(), { padding:[20,20] });
      }catch(e){ console.error('Error loading GeoJSON:', e); alert('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª. ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø³Ø§Ø± GEOJSON_URL Ø£Ùˆ Ù…Ù† Ø³ÙŠØ§Ø³Ø© CORS.'); }
    }
    (async function init(){ await loadCountsFromSheet(); await loadGeoJSON(); })();
  </script>
</body>
</html>
