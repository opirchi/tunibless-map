<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø®Ø±ÙŠØ·Ø© ØªÙˆÙ†Ø³ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© â€” TuniBless</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin="" />

  <style>
    :root{
      /* Ø£Ù„ÙˆØ§Ù† Tunibless Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© â€” ØºÙŠÙ‘Ø±Ù‡Ø§ Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ */
      --accent: #00796b;         /* Ø£Ø³Ø§Ø³ÙŠ */
      --accent-dark: #005a4f;    /* Ø¯Ø§ÙƒÙ† */
      --muted: #55606a;
      --hover-color: #ffc107;    /* Ù„ÙˆÙ† Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±ÙˆØ± */
      --feature-fill: #e6f9f4;
      --feature-border: #0b6b5e;
      --label-bg: rgba(255,255,255,0.85);
      --label-color: #073642;
    }

    html,body{ height:100%; margin:0; font-family: "Noto Kufi Arabic", "Segoe UI", Tahoma, Arial; background:#f5fbf9; color:#073642; }
    .wrap{ max-width:1200px; margin:18px auto; padding:16px; display:grid; grid-template-columns: 1fr 340px; gap:18px; align-items:start }
    header{ grid-column:1/-1; }
    h1{ margin:0 0 6px 0; font-size:20px }
    p.lead{ margin:0; color:var(--muted); }

    .map-card{ background:#fff; border-radius:12px; padding:10px; box-shadow:0 10px 30px rgba(3,56,48,0.06); height:720px; overflow:hidden }
    #map{ width:100%; height:100%; border-radius:8px; background-color: #eef6f2; }

    .side{ background:#fff; border-radius:12px; padding:14px; box-shadow:0 10px 26px rgba(3,56,48,0.04); height:720px; overflow:auto }
    .meta { color:var(--muted); margin-top:6px; }

    .btn{ display:inline-block; padding:10px 12px; border-radius:10px; font-weight:700; border:0; cursor:pointer; width:100%; text-align:center; }
    .btn-primary{ background:var(--accent); color:#fff; transition: background-color 0.18s ease; }
    .btn-primary:hover{ background:var(--accent-dark); }

    /* Ø³ØªØ§ÙŠÙ„ Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ³Ù…ÙŠØ§Øª (Ø§Ù„Ù€ labels) */
    .g-label {
      white-space: nowrap;
      padding:6px 8px;
      border-radius:8px;
      background: var(--label-bg);
      color: var(--label-color);
      font-weight:700;
      font-size:12px;
      box-shadow: 0 2px 6px rgba(3,56,48,0.12);
      transform-origin: center;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      direction: ltr; /* Ø£Ø³Ù…Ø§Ø¡ ÙØ±Ù†Ø³ÙŠØ© Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± Ù„Ù„ÙŠÙ…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¹Ù†ØµØ± */
    }
    /* Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙˆØ± - Ù†Ø²ÙŠØ¯ Ø§Ù„Ø­Ø¬Ù… */
    .g-label.label-hover {
      transform: scale(1.18);
      box-shadow: 0 6px 18px rgba(3,56,48,0.18);
      z-index: 9999;
    }

    /* responsive */
    @media (max-width:980px){
      .wrap{ grid-template-columns:1fr; padding:10px }
      .side{ height:auto; order:2 }
      .map-card{ height:520px; order:1 }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ğŸ“ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ© Ù„ØªÙˆÙ†Ø³ â€” Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</h1>
      <p class="lead">Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© Ø¸Ø§Ù‡Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© â€” Ù…Ø±Ù‘Ø± ÙÙˆÙ‚ Ø£ÙŠ ÙˆÙ„Ø§ÙŠØ© Ù„ØªÙØ¨Ø±ÙØ².</p>
    </header>

    <div class="map-card">
      <div id="map"></div>
    </div>

    <aside class="side" aria-live="polite">
      <h2 id="g-name">Ø§Ø®ØªØ± ÙˆÙ„Ø§ÙŠØ©</h2>
      <p class="meta" id="side-sub">Ù…Ø±Ù‘Ø± Ø§Ù„Ù…Ø§ÙˆØ³ ÙÙˆÙ‚ Ø£ÙŠ ÙˆÙ„Ø§ÙŠØ© Ù„Ø¹Ø±Ø¶Ù‡Ø§ Ø¨Ø§Ù„Ù„ÙˆÙ† Ø§Ù„Ù…ØºØ§ÙŠØ± ÙˆØªÙƒØ¨ÙŠØ± Ø§Ø³Ù…Ù‡Ø§.</p>
      <div style="margin-top:12px">
        <button class="btn btn-primary" id="openFormBtn" disabled>ÙØªØ­ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
      </div>
      <hr />
      <p style="color:var(--muted); font-size:13px">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø· Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ ÙƒØ§Ø¦Ù† <code>FORM_LINKS</code> Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª (Ø§Ù„Ù…ÙØ§ØªÙŠØ­: Ø£Ø³Ù…Ø§Ø¡ Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ© ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„Ø®Ø§ØµÙŠØ© <code>gouv_fr</code> Ø¯Ø§Ø®Ù„ GeoJSON).
      </p>
    </aside>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>

  <script>
    // Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ù€ GeoJSON (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯)
    const GEOJSON_URL = 'TN-gouvernorats.geojson';

    /* Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ â€” Ø¶Ø¹ Ù‡Ù†Ø§ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
       Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ·Ø§Ø¨Ù‚ Ù‚ÙŠÙ…Ø© gouv_fr ÙÙŠ Ø®Ø§ØµÙŠØ© Ø§Ù„Ù€ GeoJSON Ù„ÙƒÙ„ Ù…Ø­Ø§ÙØ·Ø© */
    const FORM_LINKS = {
      /* Ù…Ø«Ø§Ù„:
      "Ariana": "https://example.com/form-ariana",
      "Ben Arous": "https://example.com/form-ben-arous",
      */
    };

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    const map = L.map('map', {
      zoomControl: true,
      attributionControl: false
    }).setView([34.0, 9.0], 7);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      minZoom: 6,
      maxZoom: 14,
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø©
    const gNameEl = document.getElementById('g-name');
    const openFormBtn = document.getElementById('openFormBtn');

    let geojsonLayer = null;
    let boundsAll = null;

    // Ø³ØªØ§ÙŠÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙˆØ³ØªØ§ÙŠÙ„ Ø¥Ø¨Ø±Ø§Ø²
    function styleFeature(feature) {
      return {
        color: getComputedStyle(document.documentElement).getPropertyValue('--feature-border').trim() || '#0b6b5e',
        weight: 1.2,
        fillColor: getComputedStyle(document.documentElement).getPropertyValue('--feature-fill').trim() || '#e6f9f4',
        fillOpacity: 0.9
      };
    }
    const highlightStyle = {
      weight: 2.6,
      color: '#014d43',
      fillColor: getComputedStyle(document.documentElement).getPropertyValue('--hover-color').trim() || '#ffc107',
      fillOpacity: 0.95
    };

    // Ø¯Ø§Ù„Ø©: ØªÙ‡ÙŠØ¦Ø© ÙƒÙ„ Feature
    function onEachFeature(feature, layer) {
      const french = (feature.properties && (feature.properties.gouv_fr || feature.properties.nom_fr)) || 'Unknown';
      const arabic = (feature.properties && (feature.properties.gouv_ar || feature.properties.nom_ar)) || '';
      layer.feature = feature;

      // Ù†Ø¶ÙŠÙ ØªØ³Ù…ÙŠØ© Ø¯Ø§Ø¦Ù…Ø© Ø¨Ø§Ø³ØªØ¹Ù…Ø§Ù„ Marker Ù…Ø¹ DivIcon Ø¹Ù†Ø¯ Ù…Ø±ÙƒØ² Ø§Ù„Ø´ÙƒÙ„
      // Ù†Ø­Ø³Ø¨ Ù…Ø±ÙƒØ² Ø§Ù„Ø´ÙƒÙ„ (centroid approximation using bounds center)
      if (layer.getBounds) {
        const b = layer.getBounds();
        const center = b.getCenter();

        // Ø£Ù†Ø´Ø¦ DivIcon Ø¨Ø¹Ù†ØµØ± Ù„Ù‡ Ø§Ù„ÙƒÙ„Ø§Ø³ g-label Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©
        const div = L.divIcon({
          className: '', // Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… className Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ (Leaflet ØªØ¶ÙŠÙ Ù…Ø³Ø§Ø­Ø©)
          html: `<div class="g-label" data-g="${escapeHtml(french)}">${escapeHtml(french)}</div>`,
          iconSize: [100, 30],
          iconAnchor: [0, 0]
        });
        const marker = L.marker(center, { icon: div, interactive: false }).addTo(map);

        // Ø±Ø¨Ø· Ø§Ù„Ù€ marker Ø¨Ø§Ù„Ù€ layer Ù„Ø³Ù‡ÙˆÙ„Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¹Ù†Ø¯ events
        layer._labelMarker = marker;
      }

      // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØªÙØ§Ø¹Ù„
      layer.on({
        mouseover: function(e) {
          // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø´ÙƒÙ„
          e.target.setStyle(highlightStyle);
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            e.target.bringToFront();
          }
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ùˆ Ø²Ø± Ø§Ù„ÙØªØ­
          gNameEl.textContent = french + (arabic ? ` â€” ${arabic}` : '');
          openFormBtn.disabled = false;

          // ÙƒØ¨Ù‘Ø± ØªØ³Ù…ÙŠØ© Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
          const marker = e.target._labelMarker;
          if (marker && marker.getElement) {
            const el = marker.getElement();
            if (el) {
              const lbl = el.querySelector('.g-label');
              if (lbl) lbl.classList.add('label-hover');
            }
          }
        },
        mouseout: function(e) {
          // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
          geojsonLayer.resetStyle(e.target);
          gNameEl.textContent = 'Ø§Ø®ØªØ± ÙˆÙ„Ø§ÙŠØ©';
          openFormBtn.disabled = true;

          // ØªØµØºÙŠØ± Ø§Ù„ØªØ³Ù…ÙŠØ©
          const marker = e.target._labelMarker;
          if (marker && marker.getElement) {
            const el = marker.getElement();
            if (el) {
              const lbl = el.querySelector('.g-label');
              if (lbl) lbl.classList.remove('label-hover');
            }
          }
        },
        click: function(e) {
          // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø±ØŒ Ù†ÙØªØ­ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¥Ù† ÙˆÙØ¬Ø¯
          const frenchName = e.target.feature.properties.gouv_fr || e.target.feature.properties.nom_fr || null;
          const link = (frenchName && FORM_LINKS[frenchName]) ? FORM_LINKS[frenchName] : null;
          if (link) {
            window.open(link, '_blank');
          } else {
            alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØªØ³Ø¬ÙŠÙ„ Ù…ÙØ¹Ø±Ù‘Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø¨Ø¹Ø¯. Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ ÙƒØ§Ø¦Ù† FORM_LINKS Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª.');
          }
        }
      });
    }

    // ØªØ­Ù…ÙŠÙ„ GeoJSON
    fetch(GEOJSON_URL)
      .then(res => {
        if (!res.ok) throw new Error('HTTP error ' + res.status);
        return res.json();
      })
      .then(data => {
        // Ù†ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ù†Ø§Ùƒ Features
        if (!data || !data.features || !data.features.length) throw new Error('Ù…Ù„Ù GeoJSON Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£ÙŠ features.');

        // Ù†Ø¶ÙŠÙ Ø§Ù„Ø·Ø¨Ù‚Ø©
        geojsonLayer = L.geoJSON(data, {
          style: styleFeature,
          onEachFeature: onEachFeature
        }).addTo(map);

        // Ø¶Ø¨Ø· Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ´Ù…Ù„ ØªÙˆÙ†Ø³ ÙÙ‚Ø·ØŒ ÙˆÙ…Ù†Ø¹ Ø§Ù„Ø³Ø­Ø¨ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­Ø¯ÙˆØ¯
        boundsAll = geojsonLayer.getBounds();
        if (boundsAll.isValid()) {
          map.fitBounds(boundsAll, { padding: [20,20] });
          // Ù†Ø­Ø¯Ù‘Ø¯ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø³Ø­Ø¨ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¥Ù„Ù‰ Ø­ÙˆØ§Ù ØªÙˆÙ†Ø³
          map.setMaxBounds(boundsAll.pad(0.6));
        }

        // ÙÙŠ Ø¨Ø¹Ø¶ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙƒØ² marker Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ù„ÙŠØ³Øª ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­
        // (Ù„Ùˆ ÙƒØ§Ù†Øª Ø§Ù„Ø¨Ù„Ø¯ÙŠØ§Øª Ù…Ø´ØªØªØ©) -> Ù†Ø¹ÙŠØ¯ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø¹Ù†Ø¯ ÙƒÙ„ feature
        geojsonLayer.eachLayer(layer => {
          if (layer._labelMarker && layer.getBounds) {
            const cen = layer.getBounds().getCenter();
            layer._labelMarker.setLatLng(cen);
          }
        });
      })
      .catch(err => {
        console.error('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ GeoJSON:', err);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª. ØªØ£ÙƒØ¯ Ø£Ù† Ù…Ù„Ù TN-gouvernorats.geojson Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø¬Ù„Ø¯ ÙˆØµØ§Ù„Ø­.');
      });

    // Ù…Ø³Ø§Ø¹Ø¯Ø© ØµØºÙŠØ±Ø©: Ø¯Ø§Ù„Ø© Ù‡Ø±ÙˆØ¨ Ø£Ø­Ø±Ù HTML Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¢Ù…Ù† Ø¯Ø§Ø®Ù„ html string
    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Ø²Ø± ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (ÙŠÙØ¶Ù„ ØªØ­Ø¯ÙŠØ« FORM_LINKS)
    openFormBtn.addEventListener('click', () => {
      // Ø§Ø®ØªØ± Ø§Ù„ÙˆÙ„Ø§ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ù€ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ
      const text = gNameEl.textContent || '';
      // Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙØ±Ù†Ø³ÙŠ (Ø£ÙˆÙ„ ÙƒÙ„Ù…Ø© Ù‚Ø¨Ù„ dash)
      const fr = text.split('â€”')[0].trim();
      const link = (fr && FORM_LINKS[fr]) ? FORM_LINKS[fr] : null;
      if (link) window.open(link, '_blank');
      else alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ù…ÙØ¹Ø±Ù Ù„Ù‡Ø°Ù‡ Ø§Ù„ÙˆÙ„Ø§ÙŠØ© ÙÙŠ FORM_LINKS.');
    });

    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…ØªØ³Ø±Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ touch devices
    map.on('zoomend', () => {
      // Ù‚Ø¯ Ù†Ø­ØªØ§Ø¬ Ù„ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù€ labels Ø¥Ø°Ø§ ØªØºÙŠØ±Øª Ø§Ù„Ø­Ø¯ÙˆØ¯ ÙƒØ«ÙŠØ±Ø§Ù‹
      if (!geojsonLayer) return;
      geojsonLayer.eachLayer(layer => {
        if (layer._labelMarker && layer.getBounds) {
          const cen = layer.getBounds().getCenter();
          layer._labelMarker.setLatLng(cen);
        }
      });
    });
  </script>
</body>
</html>
