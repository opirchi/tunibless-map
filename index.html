<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø®Ø±ÙŠØ·Ø© ØªÙˆÙ†Ø³ - Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ„Ø§ÙŠØ©</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f8f9fa;
    }
    .header-container {
      padding: 15px;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      text-align: center;
    }
    .header-container h1 {
      margin: 0;
      font-size: 22px;
      color: #333;
    }
    .header-container p {
        margin: 5px 0 0;
        color: #666;
    }
    .map-container {
      position: relative;
      flex-grow: 1;
    }
    #map {
      height: 100%;
      width: 100%;
      background: #fff;
    }
    .label {
      background: rgba(255, 255, 255, 0.85);
      border: none;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: bold;
      white-space: nowrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      text-shadow: 0 0 2px white;
      color: #333;
    }
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .leaflet-popup-content {
      margin: 15px;
      padding: 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .leaflet-popup-content b {
      font-size: 18px;
      color: #005a8d;
      display: block;
      margin-bottom: 10px;
    }
    .popup-link {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 15px;
      background-color: #007bff;
      color: white !important;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }
    .popup-link:hover {
      background-color: #0056b3;
    }
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 1001;
      transform: translate(-50%, -50%);
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="header-container">
    <h1>Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„</h1>
    <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙˆÙ„Ø§ÙŠØªÙƒ Ù…Ù† Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„Ù„Ø¨Ø¯Ø¡</p>
  </div>

  <div class="map-container">
    <div id="map"></div>
    <div id="loader"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const formsLinks = {
      "Ariana": "https://docs.google.com/forms/d/e/1FAIpQLSeIGzfgByZSGhInjFxcxslf5vyqScEaKQHm4VsXFtYv-miJCQ/viewform",
      "Beja": "https://docs.google.com/forms/d/e/1FAIpQLScDsTtGJyP-ZstwxkztGMKgZGmDPMKeyWGR1KMxrSdr0e7QcA/viewform",
      "Ben Arous": "https://docs.google.com/forms/d/e/1FAIpQLSeLsolZbo5wQ-93bH3ffVphPx2KEIkboswDQ87v9MosOb5txA/viewform",
      "Bizerte": "https://docs.google.com/forms/d/e/1FAIpQLSeoSe8ZFLXXh4nyCPX-qYalNkOAMpQnCYDMD2kskpEvwJ4JiA/viewform",
      "Gabes": "https://docs.google.com/forms/d/e/1FAIpQLSeonk4YES79GrsuzczWTxp7NxBPinCiOdR5VpEPvXWpTEw8XA/viewform",
      "Gafsa": "https://docs.google.com/forms/d/e/1FAIpQLSdypdTUT8Bb7nLg8WVeJ8w030mbZJ8NCU3ltH4hC3YM19q3RA/viewform",
      "Jendouba": "https://docs.google.com/forms/d/e/1FAIpQLScgGlJwQAl7O7PinXf8pCupylVzWdP69f-bscQag7i0LlbVig/viewform",
      "Kairouan": "https://docs.google.com/forms/d/e/1FAIpQLSd-j6GZFTt0bG_UPqGeHEPxMETFfyyXW3F9IQE17eDQFig8wA/viewform",
      "Kasserine": "https://docs.google.com/forms/d/e/1FAIpQLSfc2HFx7o_jDx2aJ85tnWZcuVK-ylH2s24qT2LCBbrVkBpv5A/viewform",
      "Kebili": "https://docs.google.com/forms/d/e/1FAIpQLSds9-iNpbhZDDYvG-9dvN9LLeQcd3mN2s0sR3_bGblY3tjm9A/viewform",
      "Le Kef": "https://docs.google.com/forms/d/e/1FAIpQLSescTjA_TZUB2T8upCt3bLbiqN-T9gmZwH5-cpgPfUmjou5sw/viewform",
      "Mahdia": "https://docs.google.com/forms/d/e/1FAIpQLSd2e2LnvCp5PRsjWCk18SqxffASW25O9Fp9W20DPnPgMSqwGw/viewform",
      "Manouba": "https://docs.google.com/forms/d/e/1FAIpQLSfbMUil_LlnE1xaYW3BKKmRtRJpc6k55ufx5aMGS9TNP7oclg/viewform",
      "Medenine": "https://docs.google.com/forms/d/e/1FAIpQLScZNmOkZQIcFzop9XJTcgjueJAg2XqiDWD2O8Hk3n7F3MCG_Q/viewform",
      "Monastir": "https://docs.google.com/forms/d/e/1FAIpQLSewTK4rBmqaQoI69Ja9vPLrkual0rcyILTgpg5rGJq5D6SfJg/viewform",
      "Nabeul": "https://docs.google.com/forms/d/e/1FAIpQLSekivAqyuE8Wb9Bf6IvDYfi7O-y159dpyXduTlmsDNI10AVtw/viewform",
      "Sfax": "https://docs.google.com/forms/d/e/1FAIpQLScilM_Tjq3-smIDbyxNfEiZnbbuDUK4ww92s8ju4VNkoUeC9w/viewform",
      "Sidi Bouzid": "https://docs.google.com/forms/d/e/1FAIpQLSfvWAc9xFU-YGRwEc9WPuBisUtKUnLwmM6MPw6mv1DzJYZecQ/viewform",
      "Siliana": "https://docs.google.com/forms/d/e/1FAIpQLSdZ0eKwHOv-Mf07tugXwmt_vxPRvdx_ZJH8mWXJuF8bNiBDBQ/viewform",
      "Sousse": "https://docs.google.com/forms/d/e/1FAIpQLSe33qs8SD6ZDFNsNovYB1byXzPzap4u3WNxqQQi4Ca7EpixGg/viewform",
      "Tataouine": "https://docs.google.com/forms/d/e/1FAIpQLScau2aVzneLDLv4atr0ouUvVx1vzC_A8z6DcAl1Gu43UXO0aQ/viewform",
      "Tozeur": "https://docs.google.com/forms/d/e/1FAIpQLScYUXdyEDgy5LQjufhK7kamNV6HrwGN_tqvbszi1bpAE0r45Q/viewform",
      "Tunis": "https://docs.google.com/forms/d/e/1FAIpQLSdLp23YSS1HARjCq8DZL5AzNoxJ808lteqnuvfqA1IeoAghpw/viewform",
      "Zaghouan": "https://docs.google.com/forms/d/e/1FAIpQLSdHSr9wNzqhvfuTI3FD3OXT6XGRJ0h13DBHCxtxJ31vTY-pfA/viewform"
    };

    const normalize = s => (s && String(s).toLowerCase().trim()) || "";
    const normalizedForms = {};
    for (const k in formsLinks) {
      normalizedForms[normalize(k)] = formsLinks[k];
    }

    const map = L.map('map', {
      center: [33.8869, 9.5375],
      zoom: 7,
      zoomControl: true,
      attributionControl: false 
    });

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    const loader = document.getElementById('loader');
    
    const defaultStyle = {
      color: "#005a8d",
      weight: 1.5,
      fillColor: "#5da9dd",
      fillOpacity: 0.7
    };

    const highlightStyle = {
      fillColor: '#ffc107',
      fillOpacity: 0.9
    };

    fetch("TN-gouvernorats.geojson")
      .then(resp => resp.json())
      .then(geojson => {
        const tunisiaLayer = L.geoJSON(geojson, {
          style: defaultStyle,
          onEachFeature: function(feature, layer) {
            const nameFr = feature.properties?.gouv_fr || "";
            const nameAr = feature.properties?.gouv_ar || "";
            const labelText = nameAr || nameFr || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
            const lookupKey = normalize(nameFr || nameAr);

            layer.bindTooltip(labelText, {
              permanent: true,
              direction: 'center',
              className: 'label'
            });

            const formUrl = normalizedForms[lookupKey] || null;
            const popupHtml = formUrl
              ? `<b>${labelText}</b><br><a href="${formUrl}" target="_blank" class="popup-link">ğŸ“‹ ÙØªØ­ Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø±Ø©</a>`
              : `<b>${labelText}</b><br>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· Ø§Ø³ØªÙ…Ø§Ø±Ø©`;
            layer.bindPopup(popupHtml);
            
            layer.on({
                mouseover: (e) => e.target.setStyle(highlightStyle),
                mouseout: (e) => tunisiaLayer.resetStyle(e.target),
                click: (e) => {
                    map.fitBounds(e.target.getBounds());
                    if (formUrl) {
                        setTimeout(() => {
                           window.open(formUrl, '_blank');
                        }, 300); // Small delay to allow zoom animation to start
                    } else {
                        e.target.openPopup();
                    }
                }
            });
          }
        }).addTo(map);

        // --- ØªØ¹Ø¯ÙŠÙ„: ØªØ­Ø¯ÙŠØ¯ Ø¥Ø·Ø§Ø± Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆÙ…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØµØºÙŠØ± ---
        const bounds = tunisiaLayer.getBounds();
        map.fitBounds(bounds);

        // Ø§Ù†ØªØ¸Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø­ØªÙ‰ ÙŠØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø²ÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ÙŠØŒ Ø«Ù… Ø§Ø­ØµÙ„ Ø¹Ù„ÙŠÙ‡
        setTimeout(() => {
            const minZoomLevel = map.getZoom();
            map.setMinZoom(minZoomLevel); // Ù…Ù†Ø¹ Ø§Ù„ØªØµØºÙŠØ± Ù„Ø£Ø¨Ø¹Ø¯ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
        }, 500);
        
        // Ù…Ù†Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ø§Ø¨ØªØ¹Ø§Ø¯ ÙƒØ«ÙŠØ±Ø§Ù‹ Ø¹Ù† ØªÙˆÙ†Ø³
        map.setMaxBounds(bounds.pad(0.1)); 
        
        loader.style.display = 'none';
      })
      .catch(err => {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ùˆ ØªØ­Ù„ÙŠÙ„ TN-gouvernorats.geojson:", err);
        loader.style.display = 'none';
        alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ù„Ù TN-gouvernorats.geojson.");
      });

  </script>
</body>
</html>
