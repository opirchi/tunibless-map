<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>خريطة تونس - الولايات (نسخة محسنة)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #f0f0f0;
    }
    .map-container {
      position: relative;
      flex-grow: 1;
    }
    #map {
      height: 100%;
      width: 100%;
      background: #fff;
    }
    .search-container {
      padding: 10px;
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .search-container label {
      font-weight: bold;
    }
    #governorate-search {
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #ccc;
      flex-grow: 1;
      max-width: 400px;
    }
    .label {
      background: rgba(255, 255, 255, 0.85);
      border: none;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 13px;
      font-weight: bold;
      white-space: nowrap;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      text-shadow: 0 0 2px white;
      color: #333;
    }
    /* Custom Popup Style */
    .leaflet-popup-content-wrapper {
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .leaflet-popup-content {
      margin: 15px;
      padding: 0;
      font-size: 14px;
      line-height: 1.6;
    }
    .leaflet-popup-content b {
      font-size: 18px;
      color: #005a8d;
      display: block;
      margin-bottom: 10px;
    }
    .popup-link {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 15px;
      background-color: #007bff;
      color: white !important;
      text-decoration: none;
      border-radius: 5px;
      font-weight: bold;
      transition: background-color 0.2s ease;
    }
    .popup-link:hover {
      background-color: #0056b3;
    }
    /* Loader Style */
    #loader {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 1001; /* Above map tiles */
      transform: translate(-50%, -50%);
    }
    @keyframes spin {
      0% { transform: translate(-50%, -50%) rotate(0deg); }
      100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
  </style>
</head>
<body>

  <div class="search-container">
    <label for="governorate-search">ابحث عن ولاية:</label>
    <select id="governorate-search">
      <option value="">اختر ولاية...</option>
    </select>
  </div>

  <div class="map-container">
    <div id="map"></div>
    <div id="loader"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ---------- خام الروابط (عدل هنا إن احتجت) ----------
    const formsLinks = {
      "Ariana": "https://docs.google.com/forms/d/e/1FAIpQLSeIGzfgByZSGhInjFxcxslf5vyqScEaKQHm4VsXFtYv-miJCQ/viewform",
      "Beja": "https://docs.google.com/forms/d/e/1FAIpQLScDsTtGJyP-ZstwxkztGMKgZGmDPMKeyWGR1KMxrSdr0e7QcA/viewform",
      "Ben Arous": "https://docs.google.com/forms/d/e/1FAIpQLSeLsolZbo5wQ-93bH3ffVphPx2KEIkboswDQ87v9MosOb5txA/viewform",
      "Bizerte": "https://docs.google.com/forms/d/e/1FAIpQLSeoSe8ZFLXXh4nyCPX-qYalNkOAMpQnCYDMD2kskpEvwJ4JiA/viewform",
      "Gabes": "https://docs.google.com/forms/d/e/1FAIpQLSeonk4YES79GrsuzczWTxp7NxBPinCiOdR5VpEPvXWpTEw8XA/viewform",
      "Gafsa": "https://docs.google.com/forms/d/e/1FAIpQLSdypdTUT8Bb7nLg8WVeJ8w030mbZJ8NCU3ltH4hC3YM19q3RA/viewform",
      "Jendouba": "https://docs.google.com/forms/d/e/1FAIpQLScgGlJwQAl7O7PinXf8pCupylVzWdP69f-bscQag7i0LlbVig/viewform",
      "Kairouan": "https://docs.google.com/forms/d/e/1FAIpQLSd-j6GZFTt0bG_UPqGeHEPxMETFfyyXW3F9IQE17eDQFig8wA/viewform",
      "Kasserine": "https://docs.google.com/forms/d/e/1FAIpQLSfc2HFx7o_jDx2aJ85tnWZcuVK-ylH2s24qT2LCBbrVkBpv5A/viewform",
      "Kebili": "https://docs.google.com/forms/d/e/1FAIpQLSds9-iNpbhZDDYvG-9dvN9LLeQcd3mN2s0sR3_bGblY3tjm9A/viewform",
      "Le Kef": "https://docs.google.com/forms/d/e/1FAIpQLSescTjA_TZUB2T8upCt3bLbiqN-T9gmZwH5-cpgPfUmjou5sw/viewform",
      "Mahdia": "https://docs.google.com/forms/d/e/1FAIpQLSd2e2LnvCp5PRsjWCk18SqxffASW25O9Fp9W20DPnPgMSqwGw/viewform",
      "Manouba": "https://docs.google.com/forms/d/e/1FAIpQLSfbMUil_LlnE1xaYW3BKKmRtRJpc6k55ufx5aMGS9TNP7oclg/viewform",
      "Medenine": "https://docs.google.com/forms/d/e/1FAIpQLScZNmOkZQIcFzop9XJTcgjueJAg2XqiDWD2O8Hk3n7F3MCG_Q/viewform",
      "Monastir": "https://docs.google.com/forms/d/e/1FAIpQLSewTK4rBmqaQoI69Ja9vPLrkual0rcyILTgpg5rGJq5D6SfJg/viewform",
      "Nabeul": "https://docs.google.com/forms/d/e/1FAIpQLSekivAqyuE8Wb9Bf6IvDYfi7O-y159dpyXduTlmsDNI10AVtw/viewform",
      "Sfax": "https://docs.google.com/forms/d/e/1FAIpQLScilM_Tjq3-smIDbyxNfEiZnbbuDUK4ww92s8ju4VNkoUeC9w/viewform",
      "Sidi Bouzid": "https://docs.google.com/forms/d/e/1FAIpQLSfvWAc9xFU-YGRwEc9WPuBisUtKUnLwmM6MPw6mv1DzJYZecQ/viewform",
      "Siliana": "https://docs.google.com/forms/d/e/1FAIpQLSdZ0eKwHOv-Mf07tugXwmt_vxPRvdx_ZJH8mWXJuF8bNiBDBQ/viewform",
      "Sousse": "https://docs.google.com/forms/d/e/1FAIpQLSe33qs8SD6ZDFNsNovYB1byXzPzap4u3WNxqQQi4Ca7EpixGg/viewform",
      "Tataouine": "https://docs.google.com/forms/d/e/1FAIpQLScau2aVzneLDLv4atr0ouUvVx1vzC_A8z6DcAl1Gu43UXO0aQ/viewform",
      "Tozeur": "https://docs.google.com/forms/d/e/1FAIpQLScYUXdyEDgy5LQjufhK7kamNV6HrwGN_tqvbszi1bpAE0r45Q/viewform",
      "Tunis": "https://docs.google.com/forms/d/e/1FAIpQLSdLp23YSS1HARjCq8DZL5AzNoxJ808lteqnuvfqA1IeoAghpw/viewform",
      "Zaghouan": "https://docs.google.com/forms/d/e/1FAIpQLSdHSr9wNzqhvfuTI3FD3OXT6XGRJ0h13DBHCxtxJ31vTY-pfA/viewform"
    };

    const normalize = s => (s && String(s).toLowerCase().trim()) || "";

    const normalizedForms = {};
    for (const k in formsLinks) {
      normalizedForms[normalize(k)] = formsLinks[k];
    }

    const map = L.map('map', {
      center: [33.8869, 9.5375],
      zoom: 7,
      zoomControl: true,
      attributionControl: false
    });

    // Add a light basemap for context
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 19
    }).addTo(map);

    const loader = document.getElementById('loader');
    const searchSelect = document.getElementById('governorate-search');
    const governorateLayers = {};

    // Define styles
    const defaultStyle = {
      color: "#005a8d", // Dark blue border
      weight: 1.5,
      fillColor: "#5da9dd", // Light blue fill
      fillOpacity: 0.7
    };

    const highlightStyle = {
      fillColor: '#ffc107', // Yellow highlight
      fillOpacity: 0.9
    };

    fetch("TN-gouvernorats.geojson")
      .then(resp => resp.json())
      .then(geojson => {
        const tunisiaLayer = L.geoJSON(geojson, {
          style: defaultStyle,
          onEachFeature: function(feature, layer) {
            const nameFr = feature.properties?.gouv_fr || feature.properties?.gouv || "";
            const nameAr = feature.properties?.gouv_ar || "";
            const labelText = nameAr || nameFr || "غير معروف";
            const lookupKey = normalize(nameFr || nameAr);
            
            // Store layer for search functionality
            governorateLayers[labelText] = layer;

            // Attach a permanent label (tooltip)
            layer.bindTooltip(labelText, {
              permanent: true,
              direction: 'center',
              className: 'label'
            });

            // Prepare popup content
            const formUrl = normalizedForms[lookupKey] || null;
            const popupHtml = formUrl
              ? `<b>${labelText}</b><br><a href="${formUrl}" target="_blank" class="popup-link">📋 فتح الاستمارة</a>`
              : `<b>${labelText}</b><br>لا يوجد رابط استمارة`;
            layer.bindPopup(popupHtml);
            
            // --- Event Listeners ---
            layer.on({
                mouseover: (e) => e.target.setStyle(highlightStyle),
                mouseout: (e) => tunisiaLayer.resetStyle(e.target),
                click: (e) => {
                    map.fitBounds(e.target.getBounds());
                    if (formUrl) {
                        window.open(formUrl, '_blank');
                    } else {
                        e.target.openPopup();
                    }
                }
            });
          }
        }).addTo(map);

        // Fit map to Tunisia and set max bounds
        const bounds = tunisiaLayer.getBounds();
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.25));

        // --- Populate Search Dropdown ---
        const sortedGovernorates = Object.keys(governorateLayers).sort((a, b) => a.localeCompare(b, 'ar'));
        sortedGovernorates.forEach(name => {
          const option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          searchSelect.appendChild(option);
        });
        
        // --- Hide Loader ---
        loader.style.display = 'none';
      })
      .catch(err => {
        console.error("خطأ في تحميل أو تحليل TN-gouvernorats.geojson:", err);
        loader.style.display = 'none';
        alert("خطأ: لم يتم تحميل الخريطة بشكل صحيح. يرجى التحقق من وجود ملف TN-gouvernorats.geojson.");
      });

    // --- Search Event Listener ---
    searchSelect.addEventListener('change', function() {
      const selectedName = this.value;
      if (selectedName && governorateLayers[selectedName]) {
        const layer = governorateLayers[selectedName];
        map.fitBounds(layer.getBounds());
        layer.openPopup();
      }
    });
  </script>
</body>
</html>
