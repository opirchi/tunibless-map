<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>خريطة تونس - الولايات (Forms)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html,body,#map { height: 100%; margin: 0; padding: 0; background: white; }
    #map { height: 100vh; }
    .label {
      background: rgba(255,255,255,0.95);
      border: 1px solid #888;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      white-space: nowrap;
      box-shadow: 0 1px 2px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // ---------- خام الروابط (عدل هنا إن احتجت) ----------
    const formsLinks = {
      "Ariana": "https://docs.google.com/forms/d/e/1FAIpQLSeIGzfgByZSGhInjFxcxslf5vyqScEaKQHm4VsXFtYv-miJCQ/viewform",
      "Beja": "https://docs.google.com/forms/d/e/1FAIpQLScDsTtGJyP-ZstwxkztGMKgZGmDPMKeyWGR1KMxrSdr0e7QcA/viewform",
      "Ben Arous": "https://docs.google.com/forms/d/e/1FAIpQLSeLsolZbo5wQ-93bH3ffVphPx2KEIkboswDQ87v9MosOb5txA/viewform",
      "Bizerte": "https://docs.google.com/forms/d/e/1FAIpQLSeoSe8ZFLXXh4nyCPX-qYalNkOAMpQnCYDMD2kskpEvwJ4JiA/viewform",
      "Gabes": "https://docs.google.com/forms/d/e/1FAIpQLSeonk4YES79GrsuzczWTxp7NxBPinCiOdR5VpEPvXWpTEw8XA/viewform",
      "Gafsa": "https://docs.google.com/forms/d/e/1FAIpQLSdypdTUT8Bb7nLg8WVeJ8w030mbZJ8NCU3ltH4hC3YM19q3RA/viewform",
      "Jendouba": "https://docs.google.com/forms/d/e/1FAIpQLScgGlJwQAl7O7PinXf8pCupylVzWdP69f-bscQag7i0LlbVig/viewform",
      "Kairouan": "https://docs.google.com/forms/d/e/1FAIpQLSd-j6GZFTt0bG_UPqGeHEPxMETFfyyXW3F9IQE17eDQFig8wA/viewform",
      "Kasserine": "https://docs.google.com/forms/d/e/1FAIpQLSfc2HFx7o_jDx2aJ85tnWZcuVK-ylH2s24qT2LCBbrVkBpv5A/viewform",
      "Kebili": "https://docs.google.com/forms/d/e/1FAIpQLSds9-iNpbhZDDYvG-9dvN9LLeQcd3mN2s0sR3_bGblY3tjm9A/viewform",
      "Le Kef": "https://docs.google.com/forms/d/e/1FAIpQLSescTjA_TZUB2T8upCt3bLbiqN-T9gmZwH5-cpgPfUmjou5sw/viewform",
      "Mahdia": "https://docs.google.com/forms/d/e/1FAIpQLSd2e2LnvCp5PRsjWCk18SqxffASW25O9Fp9W20DPnPgMSqwGw/viewform",
      "Manouba": "https://docs.google.com/forms/d/e/1FAIpQLSfbMUil_LlnE1xaYW3BKKmRtRJpc6k55ufx5aMGS9TNP7oclg/viewform",
      "Medenine": "https://docs.google.com/forms/d/e/1FAIpQLScZNmOkZQIcFzop9XJTcgjueJAg2XqiDWD2O8Hk3n7F3MCG_Q/viewform",
      "Monastir": "https://docs.google.com/forms/d/e/1FAIpQLSewTK4rBmqaQoI69Ja9vPLrkual0rcyILTgpg5rGJq5D6SfJg/viewform",
      "Nabeul": "https://docs.google.com/forms/d/e/1FAIpQLSekivAqyuE8Wb9Bf6IvDYfi7O-y159dpyXduTlmsDNI10AVtw/viewform",
      "Sfax": "https://docs.google.com/forms/d/e/1FAIpQLScilM_Tjq3-smIDbyxNfEiZnbbuDUK4ww92s8ju4VNkoUeC9w/viewform",
      "Sidi Bouzid": "https://docs.google.com/forms/d/e/1FAIpQLSfvWAc9xFU-YGRwEc9WPuBisUtKUnLwmM6MPw6mv1DzJYZecQ/viewform",
      "Siliana": "https://docs.google.com/forms/d/e/1FAIpQLSdZ0eKwHOv-Mf07tugXwmt_vxPRvdx_ZJH8mWXJuF8bNiBDBQ/viewform",
      "Sousse": "https://docs.google.com/forms/d/e/1FAIpQLSe33qs8SD6ZDFNsNovYB1byXzPzap4u3WNxqQQi4Ca7EpixGg/viewform",
      "Tataouine": "https://docs.google.com/forms/d/e/1FAIpQLScau2aVzneLDLv4atr0ouUvVx1vzC_A8z6DcAl1Gu43UXO0aQ/viewform",
      "Tozeur": "https://docs.google.com/forms/d/e/1FAIpQLScYUXdyEDgy5LQjufhK7kamNV6HrwGN_tqvbszi1bpAE0r45Q/viewform",
      "Tunis": "https://docs.google.com/forms/d/e/1FAIpQLSdLp23YSS1HARjCq8DZL5AzNoxJ808lteqnuvfqA1IeoAghpw/viewform",
      "Zaghouan": "https://docs.google.com/forms/d/e/1FAIpQLSdHSr9wNzqhvfuTI3FD3OXT6XGRJ0h13DBHCxtxJ31vTY-pfA/viewform"
    };

    // normalize helper: lowercase + trim
    const normalize = s => (s && String(s).toLowerCase().trim()) || "";

    // create normalized lookup to avoid exact-match problems
    const normalizedForms = {};
    for (const k in formsLinks) {
      normalizedForms[normalize(k)] = formsLinks[k];
    }

    // init map without tile layer (white background)
    const map = L.map('map', {
      center: [33.8869, 9.5375],
      zoom: 6,
      zoomControl: true,
      attributionControl: false
    });

    // load local GeoJSON (file must be next to this HTML)
    fetch("TN-gouvernorats.geojson")
      .then(resp => resp.json())
      .then(geojson => {
        const tunisiaLayer = L.geoJSON(geojson, {
          style: {
            color: "#1f78b4",
            weight: 1.5,
            fillColor: "#a6cee3",
            fillOpacity: 0.6
          },
          onEachFeature: function(feature, layer) {
            // try multiple property names (fallbacks)
            const nameFr = feature.properties?.gouv_fr || feature.properties?.gouv || feature.properties?.gouv || "";
            const nameAr = feature.properties?.gouv_ar || feature.properties?.gouv || "";

            const labelText = nameAr || nameFr || "غير معروف";
            const lookupKey = normalize(nameFr || nameAr);

            // attach a permanent label (tooltip) at the layer center
            layer.bindTooltip(labelText, {
              permanent: true,
              direction: 'center',
              className: 'label'
            });

            // prepare popup content (fallback)
            const formUrl = normalizedForms[lookupKey] || null;
            const popupHtml = formUrl
              ? `<b>${labelText}</b><br><a href="${formUrl}" target="_blank">📋 فتح الاستمارة</a>`
              : `<b>${labelText}</b><br>لا يوجد رابط استمارة`;
            layer.bindPopup(popupHtml);

            // highlight on hover
            layer.on('mouseover', function () {
              layer.setStyle({ fillColor: 'yellow', fillOpacity: 0.85 });
            });
            layer.on('mouseout', function () {
              layer.setStyle({ fillColor: '#a6cee3', fillOpacity: 0.6 });
            });

            // click: zoom to feature and open form (if exists)
            layer.on('click', function (e) {
              map.fitBounds(layer.getBounds());
              if (formUrl) {
                // فتح رابط في تاب جديد (ناتج عن حدث click - يجب أن يكون مسموح)
                window.open(formUrl, '_blank');
              } else {
                // إن لم يوجد رابط، افتح البوب أب للمعلومة
                layer.openPopup();
                console.warn("No form URL for:", nameFr || nameAr, "(lookupKey:", lookupKey, ")");
              }
            });
          }
        }).addTo(map);

        // fit map to Tunisia and منع السحب خارج حدود تونس
        const bounds = tunisiaLayer.getBounds();
        map.fitBounds(bounds);
        map.setMaxBounds(bounds.pad(0.18)); // يمنع التحرك بعيداً جداً عن تونس

        // مفيد للتشخيص: اعرض أسماء ومطابقتها في الكونسول
        // (سيطبع أسماء الولايات واذا وُجد رابط أم لا)
        tunisiaLayer.eachLayer(layer => {
          const p = layer.feature?.properties || {};
          const nFr = p.name_fr || p.name || p.nom || "";
          const key = normalize(nFr || p.name_ar || "");
          console.log("Governorat:", nFr || p.name_ar || "غير معروف", " → form:", !!normalizedForms[key]);
        });

      })
      .catch(err => {
        console.error("خطأ في تحميل أو تحليل TN-gouvernorats.geojson:", err);
        alert("خطأ: لم أستطع تحميل ملف TN-gouvernorats.geojson. تأكّد أنه موجود بنفس المجلد وقم بتشغيل الخادم المحلي.");
      });
  </script>
</body>
</html>

