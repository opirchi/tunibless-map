<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>خريطة تونس التفاعلية (جغرافية دقيقة) — TuniBless</title>
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2kQYf4kX4g9v+gC2mGk0tKQd7f2yP6p3y9m3v6M=" crossorigin="" />
  <style>
    :root{ --accent:#00796b; --muted:#55606a; }
    body{ font-family: "Noto Kufi Arabic", "Segoe UI", Tahoma, Arial; margin:0; background:#f5fbf9; color:#073642 }
    .wrap{ max-width:1200px; margin:20px auto; padding:18px; display:grid; grid-template-columns: 1fr 360px; gap:18px }
    header{ grid-column:1/-1; display:flex; justify-content:space-between; align-items:center; gap:8px }
    header h1{ margin:0; font-size:20px }
    header p{ margin:0; color:var(--muted) }

    /* map card */
    .map-card{ background:#fff; border-radius:12px; padding:10px; box-shadow:0 10px 30px rgba(3,56,48,0.06); height:720px; overflow:hidden }
    #map{ width:100%; height:100%; border-radius:8px }

    /* side */
    .side{ background:linear-gradient(180deg,#ffffff,#fbfffe); border-radius:12px; padding:14px; box-shadow:0 10px 26px rgba(3,56,48,0.04); height:720px; overflow:auto }
    .side h2{ margin:0 0 6px 0 }
    .meta{ color:var(--muted); font-size:14px }
    .info-row{ display:flex; justify-content:space-between; align-items:center; padding:10px; background:#f7faf8; border-radius:8px; margin-top:12px }
    .btn{ display:inline-block; padding:10px 12px; border-radius:10px; font-weight:700; border:0; cursor:pointer }
    .btn-primary{ background:var(--accent); color:#fff }
    .btn-ghost{ background:transparent; color:var(--accent); border:1px solid #e6f3ef }
    .small{ font-size:13px; color:var(--muted) }

    /* legend */
    .legend{ margin-top:14px; font-size:13px; color:var(--muted) }

    @media (max-width:980px){ .wrap{ grid-template-columns:1fr } .side{ height:auto } .map-card{ height:520px } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>📍 الخريطة التفاعلية لتونس — محافظات دقيقة</h1>
        <p class="meta">انقر على أي محافظة لفتح نموذج التسجيل الخاص بها. الأعداد تُستدعى من Google Sheets (مباشر).</p>
      </div>
      <div style="text-align:left">
        <small class="small">TuniBless — إصدار HTML جاهز للرفع (اِدمجه في Google Sites عبر "Embed URL" أو iframe)</small>
      </div>
    </header>

    <div class="map-card" role="region" aria-label="خريطة تونس التفاعلية">
      <div id="map"></div>
    </div>

    <aside class="side" aria-live="polite">
      <h2 id="side-title">تفاصيل المحافظة</h2>
      <div class="meta" id="side-sub">مرّر فوق المحافظة أو اضغط عليها لعرض المعلومات. الأرقام الحية تستند إلى جدول Google Sheets.</div>

      <div class="info-row" style="margin-top:12px">
        <div>
          <div style="font-weight:800" id="g-name">اختر محافظة</div>
          <div class="small">المنسق: <span id="g-coord">غير محدد</span></div>
        </div>
        <div style="text-align:left">
          <div class="small">المسجلون</div>
          <div style="font-weight:800; color:#073642" id="g-count">0</div>
        </div>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px">
        <button class="btn btn-primary" id="openFormBtn">فتح نموذج التسجيل</button>
        <button class="btn btn-ghost" id="copyLinkBtn">نسخ رابط النموذج</button>
      </div>

      <div class="legend">
        <strong>ملاحظة الخصوصية:</strong>
        <div class="small" style="margin-top:6px">🔒 بيانات المتقدمين تُخزن فقط لاستخدامات التسجيل والتواصل مع المنسقين المحليين.</div>
      </div>

      <hr style="margin:14px 0; border:none; height:1px; background:#eef6f2;" />

      <div class="small">لتشغيل العداد الديناميكي: أنشئ Google Sheet وانشره (Publish to web)، ثم ضع معرف الورقة (Sheet ID) في المُتغيّر <code>SHEET_ID</code> في الكود أدناه.</div>

      <details style="margin-top:12px"><summary style="cursor:pointer">تعليمات سريعة لربط Google Sheets</summary>
        <ol class="small">
          <li>أنشئ Google Sheet يحتوي عمودين: <code>governorate</code> (العربية) و<code>count</code> (عدد المسجلين).</li>
          <li>من قائمة File → Publish to web → اختر sheet → Publish.</li>
          <liانسخ معرف الورقة من رابط URL: بين <code>/d/</code> و<code>/edit</code>.</li>
          <li>الصق المعرف في المتغير <code>SHEET_ID</code> داخل الكود.</li>
        </ol>
      </details>

    </aside>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7kG1q3f2g2Zf6X3t5Yh3p1h6Z/6x3b7q9m2p3o=" crossorigin=""></script>

  <script>
  /***** إعدادات مستخدم: ضع هنا روابط وهمية (ستستبدلها لاحقًا) *****/
  const GEOJSON_URL = 'https://raw.githubusercontent.com/riatelab/tunisie/master/data/TN-gouvernorats.geojson';
  // روابط Google Forms الوهمية لكل محافظة (مفتاح: اسم المحافظة بالعربي كما في GeoJSON)
  const FORM_LINKS = {
    "Tunis":"https://forms.gle/tunis-form",
    "Ariana":"https://forms.gle/ariana-form",
    "Ben Arous":"https://forms.gle/benarous-form",
    "Manouba":"https://forms.gle/manouba-form",
    "Nabeul":"https://forms.gle/nabeul-form",
    "Zaghouan":"https://forms.gle/zaghouan-form",
    "Bizerte":"https://forms.gle/bizerte-form",
    "Béja":"https://forms.gle/beja-form",
    "Jendouba":"https://forms.gle/jendouba-form",
    "Le Kef":"https://forms.gle/kef-form",
    "Siliana":"https://forms.gle/siliana-form",
    "Sousse":"https://forms.gle/sousse-form",
    "Monastir":"https://forms.gle/monastir-form",
    "Mahdia":"https://forms.gle/mahdia-form",
    "Kairouan":"https://forms.gle/kairouan-form",
    "Sfax":"https://forms.gle/sfax-form",
    "Gabes":"https://forms.gle/gabes-form",
    "Medenine":"https://forms.gle/medenine-form",
    "Tataouine":"https://forms.gle/tataouine-form",
    "Tozeur":"https://forms.gle/tozeur-form",
    "Kebili":"https://forms.gle/kebili-form",
    "Gafsa":"https://forms.gle/gafsa-form",
    "Sidi Bouzid":"https://forms.gle/sidibouzid-form",
    "Kasserine":"https://forms.gle/kasserine-form"
  };

  // Google Sheets: ضع معرف الورقة هنا (ستضعه أنت بعد نشر الورقة "Publish to web")
  const SHEET_ID = 'PUT_YOUR_SHEET_ID_HERE';
  // اسم الـ sheet/tab ضمن الجدول إن لم يكن الافتراضي
  const SHEET_NAME = 'Sheet1';

  /***** دوال داخلية *****/
  const map = L.map('map', { zoomControl:true, minZoom:6, maxZoom:12 }).setView([34.0, 9.0], 7);

  // طبقة بلاط محايدة بسيطة (OpenStreetMap استنادًا إلى سياسات الاستخدام، هذه جيدة للاختبار)
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  // style لحواف المحافظات
  function styleFeature(feature){
    return {
      color: '#0b6b5e',
      weight: 1.2,
      fillColor: '#e6f9f4',
      fillOpacity: 0.9
    };
  }

  // تحميل أعداد المسجلين من Google Sheets (توقعنا: جدول عمود governorate و count)
  let counts = {}; // key: name in Arabic or English depending on sheet
  async function loadCountsFromSheet(){
    if(!SHEET_ID || SHEET_ID.includes('PUT_YOUR')) return; // لم تزود المعرف بعد
    try{
      const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
      const res = await fetch(url);
      const txt = await res.text();
      // gviz returns )]}' prefix
      const json = JSON.parse(txt.substring(txt.indexOf('\n')+1).replace(/^[\s\S]*?\(/,'').replace(/\);?$/,''));
      const rows = json.table.rows;
      rows.forEach(r=>{
        const governorate = (r.c[0] && r.c[0].v) ? r.c[0].v.toString().trim() : null;
        const cnt = (r.c[1] && r.c[1].v) ? Number(r.c[1].v) : 0;
        if(governorate) counts[governorate] = cnt;
      });
      console.log('Loaded counts from sheet', counts);
    }catch(e){
      console.warn('Failed to load sheet counts (check SHEET_ID and Publish to web):', e);
    }
  }

  // تحويل أسماء GeoJSON إلى أسماء مألوفة (خريطة تحويل إن لزم)
  const nameMap = {
    // أمثلة: المفتاح كما يظهر في GeoJSON -> اسم العرض/مفتاح روابط
    "Tunis":"Tunis","Ariana":"Ariana","Ben Arous":"Ben Arous","Manouba":"Manouba",
    "Nabeul":"Nabeul","Zaghouan":"Zaghouan","Bizerte":"Bizerte","Beja":"Béja",
    "Jendouba":"Jendouba","Kef":"Le Kef","Siliana":"Siliana","Sousse":"Sousse",
    "Monastir":"Monastir","Mahdia":"Mahdia","Kairouan":"Kairouan","Sfax":"Sfax",
    "Gabes":"Gabes","Medenine":"Medenine","Tataouine":"Tataouine","Tozeur":"Tozeur",
    "Kebili":"Kebili","Gafsa":"Gafsa","Sidi Bouzid":"Sidi Bouzid","Kasserine":"Kasserine"
  };

  // عنصر الواجهة
  const sideTitle = document.getElementById('side-title');
  const gNameEl = document.getElementById('g-name');
  const gCoordEl = document.getElementById('g-coord');
  const gCountEl = document.getElementById('g-count');
  const openFormBtn = document.getElementById('openFormBtn');
  const copyLinkBtn = document.getElementById('copyLinkBtn');

  let currentFeature = null;

  // عند اختيار محافظة: تحديث اللوحة الجانبية
  function selectGovernorate(propName, feature){
    const displayName = propName;
    const mapKey = nameMap[propName] || propName;
    currentFeature = feature;
    gNameEl.textContent = displayName;
    gCoordEl.textContent = 'لم يُحدد بعد';
    gCountEl.textContent = counts[mapKey] !== undefined ? counts[mapKey] : 0;
    openFormBtn.onclick = ()=>{ const link = FORM_LINKS[mapKey] || '#'; window.open(link,'_blank') };
    copyLinkBtn.onclick = async ()=>{
      const link = FORM_LINKS[mapKey] || '';
      if(!link) return alert('لا يوجد رابط لهذه المحافظة.');
      try{ await navigator.clipboard.writeText(link); copyLinkBtn.textContent='تم النسخ!'; setTimeout(()=>copyLinkBtn.textContent='نسخ رابط النموذج',1200);}catch(e){ alert('فشل نسخ الرابط: '+link) }
  }
  }

  // highlight
  function highlightFeature(e){
    const layer = e.target;
    layer.setStyle({ weight:2.8, color:'#01695f', fillColor:'#dff6f0' });
    if(!L.Browser.ie && !L.Browser.opera && !L.Browser.edge){ layer.bringToFront(); }
    const name = layer.feature.properties.governorate || layer.feature.properties.name || layer.feature.properties.NAME_1 || layer.feature.properties.Governorat || layer.feature.properties.gouv;
    selectGovernorate(name, layer.feature);
  }
  function resetHighlight(e){
    geojson.resetStyle(e.target);
  }
  function onEachFeature(feature, layer){
    const name = feature.properties.governorate || feature.properties.name || feature.properties.NAME_1 || feature.properties.Governorat || feature.properties.gouv || 'غير معروف';
    layer.bindTooltip(`<strong>${name}</strong>`, {direction:'top', offset:[0,-8], permanent:false, className:'tt'});
    layer.on({ mouseover: highlightFeature, mouseout: resetHighlight, click: ()=>{ selectGovernorate(name, feature); const link = FORM_LINKS[nameMap[name]||name] || '#'; window.open(link,'_blank'); } });
  }

  // تحميل GeoJSON ورسمه
  let geojson = null;
  async function loadGeoJSON(){
    try{
      const resp = await fetch(GEOJSON_URL);
      if(!resp.ok) throw new Error('فشل تحميل GeoJSON');
      const data = await resp.json();

      // بعض ملفات GeoJSON تستخدم أسماء مختلفة للمحافظة — تطبع الخصائص لمطابقة الاسم
      console.log('sample feature properties:', data.features && data.features[0] && data.features[0].properties);

      geojson = L.geoJSON(data, { style: styleFeature, onEachFeature: onEachFeature }).addTo(map);

      // ضبط حدود الخريطة على طبقة
      map.fitBounds(geojson.getBounds(), { padding:[20,20] });

    }catch(e){ console.error('Error loading GeoJSON:', e); alert('تعذر تحميل حدود المحافظات. تحقق من مسار GEOJSON_URL أو من سياسة CORS.'); }
  }

  // تحميل الأعداد ثم GeoJSON
  (async function init(){
    await loadCountsFromSheet();
    await loadGeoJSON();
  })();

  </script>

  <!-- مصادر بيانات مقترحة (ستحتاجها إذا أردت تنزيل GeoJSON محليًا):
       1) GitHub - riatelab/tunisie - TN-gouvernorats.geojson (raw URL مستخدم في الكود أعلاه). 
       2) geoBoundaries / HDX / GADM - حزم حدود رسمية دقيقة.
       (تم العثور عليها عبر بحث ويب وسيتم وضع الملف مباشرة في متغير GEOJSON_URL أو استضافته على GitHub/GDrive.)
  -->
</body>
</html>
